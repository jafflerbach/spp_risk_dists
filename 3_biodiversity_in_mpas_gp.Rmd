---
title: 'MPAs and biodiversity intactness'
author: "*Compiled on `r date()` by `r Sys.info()['user']`*"
output: 
  html_document:
    code_folding: hide
    toc: true
    toc_depth: 3
    toc_float: yes
    number_sections: true
    theme: cerulean
    highlight: haddock
    includes: 
      in_header: '~/github/ohibc/src/templates/ohibc_hdr1.html'
  pdf_document:
    toc: true
---

``` {r setup, echo = TRUE, message = FALSE, warning = FALSE}

knitr::opts_chunk$set(fig.width = 6, fig.height = 4, fig.path = 'figs/',
                      echo = TRUE, message = FALSE, warning = FALSE)

library(raster)
library(data.table)

source('https://raw.githubusercontent.com/oharac/src/master/R/common.R')
  ### includes library(tidyverse); library(stringr); 
  ### dir_M points to ohi directory on Mazu; dir_O points to home dir on Mazu

dir_git <- '~/github/spp_risk_dists'

### goal specific folders and info
dir_setup <- file.path(dir_git, 'data_setup')
dir_data  <- file.path(dir_git, 'data')
dir_o_anx <- file.path(dir_O, 'git-annex/spp_risk_dists')

source(file.path(dir_git, 'data_setup/api_fxns.R'))

```

# Summary

Compare MPAs to biodiversity intactness: 

# Methods

## Examine variance against mean

Examine correlation between risk and variance?  A cell with medium risk and high variance indicates balance of low-risk species with some at risk species.  A cell with medium risk and low variance indicates a more systemically at-risk cell.

``` {r var vs mean}

mean_rast   <- raster(file.path(dir_git, 'output', 'mean_risk_raster_gp.tif'))
var_rast    <- raster(file.path(dir_git, 'output', 'var_risk_raster_gp.tif'))
n_spp_rast  <- raster(file.path(dir_git, 'output', 'n_spp_risk_raster_gp.tif'))


mean_var_df <- data.frame(mean_risk = values(mean_rast),
                          var_risk  = values(var_rast),
                          n_spp     = values(n_spp_rast)) %>%
  filter(!is.na(mean_risk)) %>%
  filter(n_spp >= 5)

mean_var_sample <- sample_n(mean_var_df, 100000)

ggplot(mean_var_sample, aes(x = mean_risk, y = var_risk)) +
  ggtheme_plot() +
  geom_point(aes(color = n_spp), alpha = .1) +
  scale_color_gradientn(colors = c('grey90', 'lightblue', 'blue1', 'blue3', 'blue4', 'purple4'),
                        values = c(0, .01, .05, .1, .25, 1))

coef_var_sample <- mean_var_df %>%
  filter(mean_risk != 0) %>%
  filter(n_spp > 5) %>%
  sample_n(100000) %>%
  mutate(coef_var = sqrt(var_risk) / mean_risk,
         inv_cv   = 1 / coef_var)
 
ggplot(coef_var_sample, aes(x = mean_risk, y = n_spp)) +
  ggtheme_plot() +
  geom_point(aes(color = n_spp), alpha = .1) +
  scale_color_gradientn(colors = c('grey90', 'lightblue', 'blue1', 'blue3', 'blue4', 'purple4'),
                        values = c(0, .01, .05, .1, .25, 1))

```

Inverse coefficient of variation, i.e. mean risk / standard deviation of risk, will tend to be higher for high means that correspond to low variance.  Low variance occurs when all species within a region are similar in risk; this indicates a system-wide moderate risk.  High variance occurs when species risks differ from the central tendency; this indicates a system with low-risk species and high risk species, most likely skewed toward low risk as long as mean is closer to 0 than 1.  High ICV probably is a good candidate for MPAs.

## Compare MPA coverage to various metrics

MPA coverage will be compared to non-MPA areas within EEZs.  The .csv codes MPAs as their numeric IUCN category (i.e. Ia = Ib = 1, II = 2, ..., VI = 6); areas that are specifically designated as no-take (that are not already in categories Ia, Ib, and II) are coded as 7; areas that are designated in the WDPA database but do not fall into one of these categories are coded as -1.

``` {r set up mpa and values dataframe}

mean_rast     <- raster(file.path(dir_git, 'output', 'mean_risk_raster_gp.tif'))
var_rast      <- raster(file.path(dir_git, 'output', 'var_risk_raster_gp.tif'))
n_spp_rast    <- raster(file.path(dir_git, 'output', 'n_spp_risk_raster_gp.tif'))
n_threat_rast <- raster(file.path(dir_git, 'output', 'n_threat_raster_gp.tif'))
trend_rast    <- raster(file.path(dir_git, 'output', 'trend_raster_gp.tif'))
eez_rast      <- raster(file.path(dir_git, 'spatial', 'eez_rast_gp.tif'))
mpa_df        <- read_csv(file.path(dir_git, 'spatial', 'wdpa_mpa_area_gp.csv'))

# tmp_rast <- calc(eez_rast, fun = function(x) x %in% c(1:212, 214:255))
### excludes high seas and antarctica

risk_df <- data.frame(cell_id   = 1:length(values(mean_rast)),
                      eez       = values(eez_rast),
                      mean_risk = values(mean_rast),
                      var_risk  = values(var_rast),
                      n_spp     = values(n_spp_rast),
                      n_threat  = values(n_threat_rast),
                      mean_trend = values(trend_rast)) %>%
  mutate(icv = mean_risk / sqrt(var_risk)) %>%
  filter(!is.na(mean_risk)) %>%
  filter(eez %in% c(1:212, 214:254)) ### 255 is disputed areas - remove...

risk_mpa_df <- risk_df %>%
  left_join(mpa_df, by = 'cell_id') %>%
  mutate(mpa_pct = ifelse(is.na(mpa_pct), 0, mpa_pct),
         wdpa_category = ifelse(is.na(wdpa_category), 0, wdpa_category)) %>%
  left_join(read_csv(file.path(dir_git, 'spatial/rgn_names.csv')), by = c('eez' = 'rgn_id')) %>%
  mutate(r1_label = str_replace(r1_label, 'Latin Am.+', 'Latin America'))

```


``` {r}

mean_rr_rast      <- raster(file.path(dir_git, 'output', 'mean_rr_risk_raster_gp.tif'))
var_rr_rast       <- raster(file.path(dir_git, 'output', 'var_rr_risk_raster_gp.tif'))
sr_rr_rast        <- raster(file.path(dir_git, 'output', 'sr_rr_risk_raster_gp.tif'))
sr_rr_threat_rast <- raster(file.path(dir_git, 'output', 'sr_rr_threat_raster_gp.tif'))
trend_rr_rast     <- raster(file.path(dir_git, 'output', 'trend_rr_raster_gp.tif'))
eez_rast          <- raster(file.path(dir_git, 'spatial', 'eez_rast_gp.tif'))
mpa_df            <- read_csv(file.path(dir_git, 'spatial', 'wdpa_mpa_area_gp.csv'))

# tmp_rast <- calc(eez_rast, fun = function(x) x %in% c(1:212, 214:255))
### excludes high seas and antarctica

risk_rr_df <- data.frame(cell_id   = 1:length(values(mean_rast)),
                         eez       = values(eez_rast),
                         mean_rr_risk  = values(mean_rr_rast),
                         var_risk      = values(var_rr_rast),
                         sr_rr_risk    = values(sr_rr_rast),
                         sr_rr_threat  = values(sr_rr_threat_rast),
                         mean_rr_trend = values(trend_rr_rast)) %>%
  filter(!is.na(mean_rr_risk)) %>%
  filter(eez %in% c(1:212, 214:254)) %>% ### 255 is disputed territories
  left_join(read_csv(file.path(dir_git, 'spatial/rgn_names.csv')), by = c('eez' = 'rgn_id'))

risk_mpa_rr_df <- risk_rr_df %>%
  left_join(mpa_df, by = 'cell_id') %>%
  mutate(mpa_pct = ifelse(is.na(mpa_pct), 0, mpa_pct),
         wdpa_category = ifelse(is.na(wdpa_category), 0, wdpa_category)) %>%
  mutate(r1_label = str_replace(r1_label, 'Latin Am.+', 'Latin America'))

```

``` {r, eval = TRUE}

no_take_df <- risk_mpa_df %>%
  mutate(mpa = wdpa_category %in% c(1, 2, 7) & mpa_pct > .5,
         protection = 'Ia, Ib, II') %>%
  group_by(mpa, r1_label) %>%
  mutate(lbl = sprintf('%s (%s km^2)', r1_label, n() * 100)) %>%
  ungroup()
no_take_means <- no_take_df %>%
  group_by(mpa, r1_label, lbl) %>%
  summarize(mu = mean(mean_risk), sd = sd(mean_risk, na.rm = TRUE), se = sd / sqrt(n()))

conserv_df <- risk_mpa_df %>%
  mutate(mpa = wdpa_category %in% c(1:4, 7) & mpa_pct > .5,
         protection = 'I-IV') %>%
  group_by(mpa, r1_label) %>%
  mutate(lbl = sprintf('%s (%s km^2)', r1_label, n() * 100)) %>%
  ungroup()
conserv_means <- conserv_df %>%
  group_by(mpa, r1_label, lbl) %>%
  summarize(mu = mean(mean_risk), sd = sd(mean_risk), se = sd / sqrt(n()))

protect_df <- risk_mpa_df %>%
  mutate(mpa = wdpa_category != 0 & mpa_pct > .5,
         protection = 'Any') %>%
  group_by(mpa, r1_label) %>%
  mutate(lbl = sprintf('%s (%s km^2)', r1_label, n() * 100)) %>%
  ungroup()
protect_means <- protect_df %>%
  group_by(mpa, r1_label, lbl) %>%
  summarize(mu = mean(mean_risk), sd = sd(mean_risk), se = sd / sqrt(n()))

no_take_rr_df <- risk_mpa_rr_df %>%
  mutate(mpa = wdpa_category %in% c(1, 2, 7) & mpa_pct > .5,
         protection = 'Ia, Ib, II') %>%
  rename(mean_risk = mean_rr_risk) %>%
  group_by(mpa, r1_label) %>%
  mutate(lbl = sprintf('%s (%s km^2)', r1_label, n() * 100)) %>%
  ungroup()
no_take_rr_means <- no_take_rr_df %>%
  group_by(mpa, r1_label, lbl) %>%
  summarize(mu = mean(mean_risk), sd = sd(mean_risk), se = sd / sqrt(n()))

conserv_rr_df <- risk_mpa_rr_df %>%
  mutate(mpa = wdpa_category %in% c(1:4, 7) & mpa_pct > .5,
         protection = 'I-IV') %>%
  rename(mean_risk = mean_rr_risk) %>%
  group_by(mpa, r1_label) %>%
  mutate(lbl = sprintf('%s (%s km^2)', r1_label, n() * 100)) %>%
  ungroup()
conserv_rr_means <- conserv_rr_df %>%
  group_by(mpa, r1_label, lbl) %>%
  summarize(mu = mean(mean_risk), sd = sd(mean_risk), se = sd / sqrt(n()))

protect_rr_df <- risk_mpa_rr_df %>%
  mutate(mpa = wdpa_category != 0 & mpa_pct > .5,
         protection = 'Any') %>%
  rename(mean_risk = mean_rr_risk) %>%
  group_by(mpa, r1_label) %>%
  mutate(lbl = sprintf('%s (%s km^2)', r1_label, n() * 100)) %>%
  ungroup()
protect_rr_means <- protect_rr_df %>%
  group_by(mpa, r1_label, lbl) %>%
  summarize(mu = mean(mean_risk), sd = sd(mean_risk), se = sd / sqrt(n()))

all_means <- list('no_take' = no_take_means, 
                  'conserv' = conserv_means,
                  'protect' = protect_means,
                  'no_take_rr' = no_take_rr_means, 
                  'conserv_rr' = conserv_rr_means,
                  'protect_rr' = protect_rr_means) %>%
  bind_rows(.id = 'grouping') %>%
  group_by(grouping, r1_label) %>%
  arrange(desc(mpa)) %>% ### TRUE then FALSE
  summarize(cat_diff = 5 * round(mu[2] - mu[1], 4),
            se_add   = 5 * round(sum(se), 6))

DT::datatable(all_means)

```



There seem to be two philosophies of MPA priority: place MPAs in impacted areas to reduce pressure and prevent further degradatation, or place MPAs to protect pristine places to maintain their pristine state.  This suggests that we may see a bimodal distribution of mean risk within MPA cells relative to the distribution of mean risk in general.

### Mean risk

``` {r plot_function}

plot_dist <- function(df, means_df) {
  x <- ggplot(df, aes(x = mean_risk, fill = mpa, color = mpa)) +
    ggtheme_plot() +
    theme(strip.text.y = element_text(angle = 0)) +
    geom_vline(data = means_df, aes(xintercept = mu, linetype = mpa)) +
    geom_density(alpha = .2, size = .25) +
    scale_x_continuous(expand = c(0, 0)) +
    scale_y_continuous(expand = c(0, 0)) +
    theme(axis.text.y = element_blank(),
          axis.title.y = element_blank()) +
    facet_grid( r1_label ~ ., scales = 'free_y') +
    scale_x_continuous(labels = c('LC', 'NT', 'VU', 'EN', 'CR', 'EX'),
                       breaks = c( 0.0,  0.2,  0.4,  0.6,  0.8,  1.0))
  
  return(x)
}

```

``` {r}

mpa_dens_files <- path.expand(c(file.path(dir_git, 'ms_figures/fig_3_mpa_notake_gp.png'),
                                file.path(dir_git, 'ms_figures/fig_SI_mpa_conserv_gp.png'),
                                file.path(dir_git, 'ms_figures/fig_SI_mpa_any_prot_gp.png')))

x <- plot_dist(no_take_df, no_take_means) +
  labs(title = 'dist of mean_risk inside and outside MPAs - no take')

ggsave(mpa_dens_files[1],
       width = 6, height = 4, dpi = 300, units = 'in')

# x <- ggplot(no_take_df, aes(x = icv, fill = mpa, color = mpa)) +
#   ggtheme_plot() +
#   geom_density(alpha = .2, size = .25) +
#   theme(axis.text.y = element_blank(),
#         axis.title.y = element_blank()) +
#   facet_grid( r1_label ~ ., scales = 'free_y') +
#   labs(title = 'dist of ICV inside and outside MPAs - no take')

x <- plot_dist(conserv_df, conserv_means) +
  labs(title = 'dist of mean_risk inside and outside MPAs - I-IV')

ggsave(mpa_dens_files[2],
       width = 6, height = 4, dpi = 300, units = 'in')

x <- plot_dist(protect_df, protect_means) +
  labs(title = 'dist of mean_risk inside and outside MPAs - any MPA')

ggsave(mpa_dens_files[3],
       width = 6, height = 4, dpi = 300, units = 'in')

knitr::include_graphics(mpa_dens_files)
```

### Mean risk, range-rarity-weighted

``` {r}

mpa_rr_dens_files <- path.expand(c(file.path(dir_git, 'ms_figures/fig_SI_mpa_notake_rr_gp.png'),
                                file.path(dir_git, 'ms_figures/fig_SI_mpa_conserv_rr_gp.png'),
                                file.path(dir_git, 'ms_figures/fig_SI_mpa_any_prot_rr_gp.png')))

x <- plot_dist(no_take_rr_df, no_take_rr_means) +
  labs(title = 'dist of rr-weighted mean_risk inside and outside MPAs - no take')

ggsave(mpa_rr_dens_files[1],
       width = 6, height = 4, dpi = 300, units = 'in')

x <- plot_dist(conserv_rr_df, conserv_rr_means) +
  labs(title = 'dist of rr-weighted mean_risk inside and outside MPAs - I-IV')

ggsave(mpa_rr_dens_files[2],
       width = 6, height = 4, dpi = 300, units = 'in')


x <- plot_dist(protect_rr_df, protect_rr_means) +
  labs(title = 'dist of rr-weighted mean_risk inside and outside MPAs - any MPA')

ggsave(mpa_rr_dens_files[3],
       width = 6, height = 4, dpi = 300, units = 'in')

knitr::include_graphics(mpa_rr_dens_files)

```

## Now for global!

``` {r, eval = TRUE}

no_take_df <- risk_mpa_df %>%
  mutate(mpa = wdpa_category %in% c(1, 2, 7) & mpa_pct > .5,
         protection = 'Ia, Ib, II')
no_take_means <- no_take_df %>%
  group_by(mpa) %>%
  summarize(mu = mean(mean_risk), sd = sd(mean_risk, na.rm = TRUE), se = sd / sqrt(n()))

conserv_df <- risk_mpa_df %>%
  mutate(mpa = wdpa_category %in% c(1:4, 7) & mpa_pct > .5,
         protection = 'I-IV')
conserv_means <- conserv_df %>%
  group_by(mpa) %>%
  summarize(mu = mean(mean_risk), sd = sd(mean_risk), se = sd / sqrt(n()))

protect_df <- risk_mpa_df %>%
  mutate(mpa = wdpa_category != 0 & mpa_pct > .5,
         protection = 'Any')
protect_means <- protect_df %>%
  group_by(mpa) %>%
  summarize(mu = mean(mean_risk), sd = sd(mean_risk), se = sd / sqrt(n()))

no_take_rr_df <- risk_mpa_rr_df %>%
  mutate(mpa = wdpa_category %in% c(1, 2, 7) & mpa_pct > .5,
         protection = 'Ia, Ib, II') %>%
  rename(mean_risk = mean_rr_risk)
no_take_rr_means <- no_take_rr_df %>%
  group_by(mpa) %>%
  summarize(mu = mean(mean_risk), sd = sd(mean_risk), se = sd / sqrt(n()))

conserv_rr_df <- risk_mpa_rr_df %>%
  mutate(mpa = wdpa_category %in% c(1:4, 7) & mpa_pct > .5,
         protection = 'I-IV') %>%
  rename(mean_risk = mean_rr_risk)
conserv_rr_means <- conserv_rr_df %>%
  group_by(mpa) %>%
  summarize(mu = mean(mean_risk), sd = sd(mean_risk), se = sd / sqrt(n()))

protect_rr_df <- risk_mpa_rr_df %>%
  mutate(mpa = wdpa_category != 0 & mpa_pct > .5,
         protection = 'Any') %>%
  rename(mean_risk = mean_rr_risk)
protect_rr_means <- protect_rr_df %>%
  group_by(mpa) %>%
  summarize(mu = mean(mean_risk), sd = sd(mean_risk), se = sd / sqrt(n()))

all_means <- list('no_take' = no_take_means, 
                  'conserv' = conserv_means,
                  'protect' = protect_means,
                  'no_take_rr' = no_take_rr_means, 
                  'conserv_rr' = conserv_rr_means,
                  'protect_rr' = protect_rr_means) %>%
  bind_rows(.id = 'grouping') %>%
  group_by(grouping) %>%
  arrange(desc(mpa)) %>% ### TRUE then FALSE
  summarize(cat_diff = 5 * round(mu[2] - mu[1], 4),
            se_add   = 5 * round(sum(se), 6))

DT::datatable(all_means)

```


### Mean risk, global

``` {r plot_function 2}

plot_dist_gl <- function(df, means_df) {
  x <- ggplot(df, aes(x = mean_risk, fill = mpa, color = mpa)) +
    ggtheme_plot() +
    geom_vline(data = means_df, aes(xintercept = mu, linetype = mpa)) +
    geom_density(alpha = .2, size = .25) +
    theme(axis.text.y = element_blank(),
          axis.title.y = element_blank()) +
    scale_x_continuous(expand = c(0, 0)) +
    scale_y_continuous(expand = c(0, 0)) +
    scale_x_continuous(labels = c('LC', 'NT', 'VU', 'EN', 'CR', 'EX'),
                       breaks = c( 0.0,  0.2,  0.4,  0.6,  0.8,  1.0))
  
  return(x)
}

```

``` {r}

mpa_dens_files <- path.expand(c(file.path(dir_git, 'ms_figures/fig_3_mpa_notake_gp_gl.png'),
                                file.path(dir_git, 'ms_figures/fig_SI_mpa_conserv_gp_gl.png'),
                                file.path(dir_git, 'ms_figures/fig_SI_mpa_any_prot_gp_gl.png')))

x <- plot_dist_gl(no_take_df, no_take_means) +
  labs(title = 'dist of mean_risk inside and outside MPAs - no take')

ggsave(mpa_dens_files[1],
       width = 6, height = 4, dpi = 300, units = 'in')

x <- plot_dist_gl(conserv_df, conserv_means) +
  labs(title = 'dist of mean_risk inside and outside MPAs - I-IV')

ggsave(mpa_dens_files[2],
       width = 6, height = 4, dpi = 300, units = 'in')

x <- plot_dist_gl(protect_df, protect_means) +
  labs(title = 'dist of mean_risk inside and outside MPAs - any MPA')

ggsave(mpa_dens_files[3],
       width = 6, height = 4, dpi = 300, units = 'in')

knitr::include_graphics(mpa_dens_files)
```

### Mean risk, range-rarity-weighted

``` {r}

mpa_rr_dens_files <- path.expand(c(file.path(dir_git, 'ms_figures/fig_SI_mpa_notake_rr_gp_gl.png'),
                                file.path(dir_git, 'ms_figures/fig_SI_mpa_conserv_rr_gp_gl.png'),
                                file.path(dir_git, 'ms_figures/fig_SI_mpa_any_prot_rr_gp_gl.png')))

x <- plot_dist_gl(no_take_rr_df, no_take_rr_means) +
  labs(title = 'dist of rr-weighted mean_risk inside and outside MPAs - no take')

ggsave(mpa_rr_dens_files[1],
       width = 6, height = 4, dpi = 300, units = 'in')

x <- plot_dist_gl(conserv_rr_df, conserv_rr_means) +
  labs(title = 'dist of rr-weighted mean_risk inside and outside MPAs - I-IV')

ggsave(mpa_rr_dens_files[2],
       width = 6, height = 4, dpi = 300, units = 'in')


x <- plot_dist_gl(protect_rr_df, protect_rr_means) +
  labs(title = 'dist of rr-weighted mean_risk inside and outside MPAs - any MPA')

ggsave(mpa_rr_dens_files[3],
       width = 6, height = 4, dpi = 300, units = 'in')

knitr::include_graphics(mpa_rr_dens_files)

```

