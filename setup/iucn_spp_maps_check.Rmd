---
title: 'Identify IUCN spp maps included and missing'
author: "*Compiled on `r date()` by `r Sys.info()['user']`*"
output: 
  html_document:
    code_folding: hide
    toc: true
    toc_depth: 3
    toc_float: yes
    number_sections: true
    theme: cerulean
    highlight: haddock
    includes: 
      in_header: '~/github/src/templates/ohara_hdr.html'
  pdf_document:
    toc: true
---

``` {r setup, echo = TRUE, message = FALSE, warning = FALSE}

knitr::opts_chunk$set(fig.width = 6, fig.height = 4, fig.path = 'Figs/',
                      echo = TRUE, message = FALSE, warning = FALSE)


source('https://raw.githubusercontent.com/oharac/src/master/R/common.R')

dir_git <- '~/github/spp_risk_dists'
dir_o_anx <- file.path(dir_O, 'git-annex/spp_risk_dists')

### goal specific folders and info
dir_setup   <- file.path(dir_git, 'data_setup')

### project specific folders and info
source(file.path(dir_git, 'data_setup/common_fxns.R'))

```

# Summary

Identify maps available from the IUCN Spatial Data Download page http://www.iucnredlist.org/technical-documents/spatial-data and compare to IUCN marine species from the API.  

Marine species are identified from the IUCN Red List API by pulling habitat data and filtering to those species whose habitat includes marine  habitats (categories 9-12, and marine-associated artificial habitat in category 15; see `1_set_up_iucn_risk.Rmd`).  Note that category 13 is coastal species (e.g. dunes, freshwater or brackish coastal lakes, etc) but this often includes species whose dependence on "marine" habitats is spurious (e.g. hippos).  See the script for filtering details.

Maps list is generated by `5b_process_spp_shps.Rmd` (including singleton shps from Gina at IUCN).

# Data Sources

### IUCN Red List API

### IUCN Red List spatial data download

# Methods

## Compare map list to API info list

Compare the list of species from the downloaded maps to the list of marine species from the API operations.  

* From the species information from API (93,000+ species), filter to those with species IDs in the list of marine species based on habitat.  
* Then join to the map information dataframe.  
* Mapped species can be identified by the dbf file information; non-mapped species will be missing a dbf file (NA).
* Note: Species with subpopulations are noted in the shapefiles by the parent ID number (not the subpopulation ID number) and a text field describing the subpopulation.  
    * These may show up as non-mapped, since the subpop ID from the API does not find a match in the ID number from the map file.  The parent will match but not the subpopulations.

``` {r}

map_info <- read_csv(file.path(dir_git, 'data',
                               sprintf('spp_marine_maps_%s.csv', api_version)),
                     col_types = 'ddciccc') %>%
  select(-presence, -max_depth, -sciname) %>%
  distinct() %>%
  mutate(dbf_file = basename(dbf_file))

marine_spp_by_hab <- read_csv(file.path(dir_git, 'data', 
                                        sprintf('spp_marine_from_api_%s.csv', api_version)),
                              col_types = 'dcc')

spp_info_mar <- read_csv(file.path(dir_git, 'data',
                           sprintf('iucn_risk_current_%s.csv', api_version)),
                         col_types = 'dccicccdc')
spp_info_all <- read_csv(file.path(dir_o_anx, 'iucn',
                           sprintf('spp_info_from_api_%s.csv', api_version)),
                         col_types = 'dccccccccc')

marine_spp_mapped <- marine_spp_by_hab %>%
  full_join(map_info, by = c('iucn_sid')) %>%
  left_join(spp_info_mar, by = 'iucn_sid') %>%
  filter(!is.na(iucn_sid)) %>%
  select(iucn_sid, dbf_file, 
         sciname, main_common_name, 
         cat, cat_score, 
         published_year, iucn_version) %>%
  distinct()

write_csv(marine_spp_mapped, file.path(dir_git, 'data/map_check/marine_spp_mapped.csv'))

```

### Species unavailable from Spatial Data Download

``` {r}

marine_spp_mapped <- read_csv(file.path(dir_git, 'data/map_check/marine_spp_mapped.csv'),
                              col_types = 'dccccddc')

# marine_spp_mapped$iucn_sid %>% unique() %>% length()
# 12913 spp either marine by hab or incl in marine maps
# marine_spp_mapped %>% filter(!is.na(cat_score)) %>% .$iucn_sid %>% unique() %>% length()
# 10141 spp with valid assessment scores

maps_missing <- marine_spp_mapped %>%
  filter(is.na(dbf_file)) %>%
  select(-dbf_file) %>%
  distinct()

write_csv(maps_missing, file.path(dir_git, 'data/map_check/maps_missing.csv'))

maps_missing_with_score <- maps_missing %>%
  filter(!is.na(cat_score))

write_csv(maps_missing_with_score, file.path(dir_git, 'data/map_check/assessed_maps_missing.csv'))

```

## Distribution of category scores for mapped spp

``` {r}

marine_spp_mapped <- read_csv(file.path(dir_git, 'data/map_check/marine_spp_mapped.csv'),
                              col_types = 'dccccddc')

df <- marine_spp_mapped %>%
  filter(!is.na(cat_score)) %>%
  mutate(comp_assessed = (dbf_file != tolower(dbf_file)),
         comp_assessed = ifelse(is.na(dbf_file), FALSE, comp_assessed)) %>% 
    ### Red List site shps are uppercase names
  mutate(included = !is.na(dbf_file))

df %>%
  group_by(included) %>%
  summarize(mean_cat = mean(cat_score))

df %>%
  group_by(comp_assessed) %>%
  summarize(mean_cat = mean(cat_score))
```
``` {r}
marine_spp_mapped <- read_csv(file.path(dir_git, 'data/map_check/marine_spp_mapped.csv'),
                              col_types = 'dccccddc') 

df <- marine_spp_mapped %>%
  filter(!is.na(cat_score)) %>%
  left_join(spp_info_all %>% select(-sciname), by = 'iucn_sid') %>%
  select(iucn_sid, sciname, dbf_file,
         kingdom, phylum, class, order,
         cat_score) %>%
  mutate(taxon = case_when(phylum != 'CHORDATA'       ~ tolower(phylum),
                           class  != 'ACTINOPTERYGII' ~ tolower(class),
                           TRUE                       ~ tolower(order))) 

comp_ass_taxa <- df %>%
  filter(!is.na(dbf_file)) %>%
  mutate(comp_assessed = dbf_file != tolower(dbf_file)) %>%
  select(taxon, comp_assessed) %>%
  mutate(comp_assessed = ifelse(is.na(comp_assessed), FALSE, comp_assessed)) %>%
  distinct()
  
  
df2 <- df %>%
  left_join(comp_ass_taxa, by = c('taxon')) %>% 
    ### Red List site shps are uppercase names
  mutate(included = !is.na(dbf_file))


included_df <- df2 %>%
  group_by(included, taxon) %>%
  summarize(mean_cat = mean(cat_score), n = n()) %>%
  arrange(taxon)

DT::datatable(included_df)

comp_assessed_df <- df2  %>%
  filter(!(comp_assessed & !included)) %>%
  group_by(comp_assessed, taxon, included) %>%
  summarize(mean_cat = mean(cat_score), n = n()) %>%
  arrange(taxon)

DT::datatable(comp_assessed_df)

```