---
title: 'Biodiversity maps as density plots'
author: "*Compiled on `r date()` by `r Sys.info()['user']`*"
output: 
  html_document:
    code_folding: hide
    toc: true
    toc_depth: 3
    toc_float: yes
    number_sections: true
    theme: cerulean
    highlight: haddock
    includes: 
      in_header: '~/github/ohibc/src/templates/ohibc_hdr1.html'
  pdf_document:
    toc: true
---

``` {r setup, echo = TRUE, message = FALSE, warning = FALSE}

knitr::opts_chunk$set(fig.width = 6, fig.height = 4, fig.path = 'figs/',
                      echo = TRUE, message = FALSE, warning = FALSE)

library(raster)
library(data.table)

source('https://raw.githubusercontent.com/oharac/src/master/R/common.R')
  ### includes library(tidyverse); library(stringr); 
  ### dir_M points to ohi directory on Mazu; dir_O points to home dir on Mazu

dir_git <- '~/github/spp_risk_dists'

### goal specific folders and info
dir_setup <- file.path(dir_git, 'data_setup')
dir_data  <- file.path(dir_git, 'data')
dir_o_anx <- file.path(dir_O, 'git-annex/spp_risk_dists')

source(file.path(dir_git, 'data_setup/api_fxns.R'))

```

# Summary

Compare MPAs to biodiversity intactness: 

# Methods

## Density plots of risks

Do we want a mean value for each?  (area-weighted)

``` {r set up mpa and values dataframe}

mean_rast          <- raster(file.path(dir_git, 'output', 'mean_risk_raster_gp.tif'))
nspp_rast          <- raster(file.path(dir_git, 'output', 'n_spp_risk_raster_gp.tif'))
pct_threat_rast    <- raster(file.path(dir_git, 'output', 'pct_threat_raster_gp.tif'))
mean_rr_rast       <- raster(file.path(dir_git, 'output', 'mean_rr_risk_raster_gp.tif'))
nspp_rr_rast       <- raster(file.path(dir_git, 'output', 'sr_rr_risk_raster_gp.tif'))
pct_threat_rr_rast <- raster(file.path(dir_git, 'output', 'sr_rr_pct_threat_raster_gp.tif'))
eez_rast           <- raster(file.path(dir_git, 'spatial', 'eez_rast_gp.tif'))

# ncell(mean_rast)
### create dataframe with both unweighted and rr-weighted values in columns 
### for faceting or mapping to aesthetics

risk_df <- data.frame(cell_id    = rep(1:ncell(mean_rast), times = 2),
                      eez        = rep(values(eez_rast), times = 2),
                      mean_risk  = c(values(mean_rast), values(mean_rr_rast)),
                      spp_rich   = c(values(nspp_rast), values(nspp_rr_rast)),
                      pct_threat = c(values(pct_threat_rast), values(pct_threat_rr_rast)),
                      wt         = rep(c('unweighted', 'range-rarity'), each = ncell(mean_rast))) %>%
  filter(!is.na(mean_risk)) %>%
  left_join(read_csv(file.path(dir_git, 'spatial/rgn_names.csv')), by = c('eez' = 'rgn_id'))


```

### global

``` {r plot global}

nspp_vec <- values(nspp_rast)[!is.na(values(nspp_rast))]
nspp_ecdf <- ecdf(nspp_vec)

nspp_pcts <- data.frame(spp_counts = c(1, 3, 5, 10, 20)) %>%
  mutate(pctile = nspp_ecdf(spp_counts))

knitr::kable(nspp_pcts, caption = 'Percentile of ocean with a given number of species or fewer')

############################

risk_vec <- values(mean_rast)[!is.na(values(mean_rast))]
risk_ecdf <- ecdf(risk_vec)

risk_pcts <- data.frame(risk_vals = c(.05, .10, .15, .20, .25, .30, .50, .75)) %>%
  mutate(pctile = risk_ecdf(risk_vals))

knitr::kable(risk_pcts, caption = 'Percentile of ocean with a given risk (or lower)')

############################

risk_rr_vec <- values(mean_rr_rast)[!is.na(values(mean_rr_rast))]
risk_rr_ecdf <- ecdf(risk_rr_vec)

risk_rr_pcts <- data.frame(risk_vals = c(.05, .10, .15, .20, .25, .30, .50, .75)) %>%
  mutate(pctile = risk_rr_ecdf(risk_vals))

knitr::kable(risk_rr_pcts, 
             caption = 'Percentile of ocean with a given risk or lower (rr-weighted)')

############################

pct_thr_vec <- values(pct_threat_rast)[!is.na(values(pct_threat_rast))]
pct_thr_ecdf <- ecdf(pct_thr_vec)

pct_thr_pcts <- data.frame(pct_thr_vals = c(.05, .10, .15, .20, .25, .30, .50, .75)) %>%
  mutate(pctile = pct_thr_ecdf(pct_thr_vals))

knitr::kable(pct_thr_pcts, caption = 'Percentile of ocean with a given percent threatened (or lower)')

############################

pct_thr_rr_vec <- values(pct_threat_rr_rast)[!is.na(values(pct_threat_rr_rast))]
pct_thr_rr_ecdf <- ecdf(pct_thr_rr_vec)

pct_thr_rr_pcts <- data.frame(pct_thr_vals = c(.05, .10, .15, .20, .25, .30, .50, .75)) %>%
  mutate(pctile = pct_thr_rr_ecdf(pct_thr_vals))

knitr::kable(pct_thr_rr_pcts, 
             caption = 'Percentile of ocean with a given percent threatened or lower (rr-weighted)')

##############################



risk_dens_file    <- file.path(dir_git, 'ms_figures/fig3_risk_density_gp.png')
pct_thr_dens_file <- file.path(dir_git, 'ms_figures/fig3_pct_threat_density_gp.png')

if(!file.exists(risk_dens_file)) {
  x <- ggplot(risk_df, aes(x = mean_risk, fill = wt, color = wt, ..scaled..)) +
    ggtheme_plot() +
    geom_density(alpha = .3, size = .25) +
    theme(axis.text.y = element_blank(),
          axis.title.y = element_blank()) +
    labs(title = 'risk')

  ggsave(filename = risk_dens_file,
         width = 6, height = 4, units = 'in', dpi = 300)
}

if(!file.exists(pct_thr_dens_file)) {
  x <- ggplot(risk_df, aes(x = pct_threat, fill = wt, color = wt, ..scaled..)) +
    ggtheme_plot() +
    geom_density(alpha = .3, size = .25) +
    theme(axis.text.y = element_blank(),
          axis.title.y = element_blank()) +
    labs(title = 'percent threatened')
  
  ggsave(filename = pct_thr_dens_file,
         width = 6, height = 4, units = 'in', dpi = 300)
}

# ggplot(risk_df, aes(x = spp_rich, fill = wt, color = wt, ..scaled..)) +
#   ggtheme_plot() +
#   geom_density(alpha = .3, size = .25) +
#   theme(axis.text.y = element_blank(),
#         axis.title.y = element_blank()) +
#   labs(title = 'species richness')
# 
# ggsave(filename = file.path(dir_git, 'ms_figures/fig_SI_spp_rich_density_gp.png'),
#        width = 6, height = 4, units = 'in', dpi = 300)

knitr::include_graphics(path.expand(risk_dens_file))

knitr::include_graphics(path.expand(pct_thr_dens_file))

```


### regional

``` {r plot regional}

rgn_risk_dens_file    <- file.path(dir_git, 'ms_figures/fig_SI_risk_density_rgns_gp.png')
rgn_pct_thr_dens_file <- file.path(dir_git, 'ms_figures/fig_SI_pct_threat_density_rgns_gp.png')


if(!file.exists(rgn_risk_dens_file)) {
  x <- ggplot(risk_df, aes(x = mean_risk, fill = wt, color = wt, ..scaled..)) +
    ggtheme_plot() +
    geom_density(alpha = .3, size = .25) +
    theme(axis.text.y  = element_blank(),
          axis.title.y = element_blank()) +
    facet_wrap( ~ r1_label, scales = 'free_y') +
    labs(title = 'risk')
  
  ggsave(filename = rgn_risk_dens_file,
         width = 6, height = 4, units = 'in', dpi = 300)
}
  
if(!file.exists(rgn_pct_thr_dens_file)) {
  x <- ggplot(risk_df, aes(x = pct_threat, fill = wt, color = wt, ..scaled..)) +
    ggtheme_plot() +
    geom_density(alpha = .3, size = .25) +
    theme(axis.text.y  = element_blank(),
          axis.title.y = element_blank()) +
    facet_wrap( ~ r1_label, scales = 'free_y') +
    labs(title = 'percent threatened')
  
  ggsave(filename = rgn_pct_thr_dens_file,
         width = 6, height = 4, units = 'in', dpi = 300)
}

knitr::include_graphics(path.expand(rgn_risk_dens_file))

knitr::include_graphics(path.expand(rgn_pct_thr_dens_file))

```
