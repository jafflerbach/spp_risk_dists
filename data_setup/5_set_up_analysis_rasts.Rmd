---
title: 'Set up rasters for analysis'
author: "*Compiled on `r date()` by `r Sys.info()['user']`*"
output: 
  html_document:
    code_folding: hide
    toc: true
    toc_depth: 3
    toc_float: yes
    number_sections: true
    theme: cerulean
    highlight: haddock
    includes: 
      in_header: '~/github/ohibc/src/templates/ohibc_hdr1.html'
  pdf_document:
    toc: true
---

``` {r setup, echo = TRUE, message = FALSE, warning = FALSE}

knitr::opts_chunk$set(fig.width = 6, fig.height = 4, fig.path = 'Figs/',
                      echo = TRUE, message = FALSE, warning = FALSE)

library(raster)
library(sf)
library(fasterize)

source('~/github/src/R/common.R')  ###
  ### includes library(tidyverse); library(stringr); dir_M points to ohi directory

dir_git <- '~/github/spp_health_dists'

### goal specific folders and info
dir_setup   <- file.path(dir_git, 'data_setup')
dir_spatial <- file.path(dir_git, 'spatial')
dir_anx     <- file.path(dir_M, 'git-annex')
dir_o_anx   <- file.path(dir_O, 'git-annex/spp_health_dists')
# ### provenance tracking
library(provRmd); prov_setup()

### support scripts
source('~/github/src/R/rast_tools.R') 
  ### raster plotting and analyzing scripts

ocean_base <- raster(file.path(dir_M, 'model/GL-NCEAS-Halpern2008/tmp/ocean.tif'))


```

# Summary

For various spatial analyses, it may be easier to work using a Mollweide raster that matches Cumulative Impacts resolution:

* Ocean area - use ocean area raster from CHI and/or OHI as base for all other rasters
* LOICZID masked to ocean areas only
* WDPA by oldest year of protection
    * IUCN I - IV
    * IUCN I - VI
* MEOW ecoregions
* Random raster ~ uniform (0, 1) masked to ocean cells
    * this can be used to take random samples for quick regression tests


# Data Sources

# Methods

## Create a clean CHI ocean raster of NA and 1 values

not necessary? seems like `ocean_base` has that covered...

## Create an LOICZID raster to match CHI base raster

``` {r reproject_loiczid_to_mollweide}

loiczid_wgs84 <- raster(file.path(dir_spatial, 'loiczid_raster.tif'))

loiczid_moll_file <- file.path(dir_o_anx, 'spatial/loiczid_moll_934m.tif')

if(!file.exists(loiczid_moll_file)) {
  loiczid_moll <- projectRaster(from     = loiczid_wgs84, 
                                to       = ocean_base,
                                method   = 'ngb') # ,
                                # progress = 'text')
  
  ### mask to just ocean cells based on Cumulative Impacts ocean raster
  loiczid_moll_ocean <- loiczid_moll
  values(loiczid_moll_ocean)[is.na(values(ocean_base))] <- NA
  
  writeRaster(loiczid_moll_ocean, loiczid_moll_file, overwrite = TRUE)
  
}

```

## Create WDPA rasters to match CHI base raster

Marine regions are any protected area with MARINE flag of 1 or 2, or non-zero GIS_M_AREA.
    
Rasters for analysis:

* raster of all marine protected areas (designated/adopted)
* raster of marine protected areas IUCN I - VI
* raster of marine protected areas IUCN I - IV (conservation-oriented protections)

``` {r project_wdpa_to_mollweide}

wdpa_poly <- read_sf(file.path(dir_o_anx, 'wdpa/wdpa_dec2017/WDPA_Dec2017-shapefile-polygons.shp'))

wdpa_marine <- wdpa_poly %>%
  filter(MARINE > 0 | GIS_M_AREA > 0) %>%
  filter(STATUS %in% c('Designated', 'Adopted')) %>%
  arrange(STATUS_YR) %>%
  st_transform(crs = proj4string(ocean_base))
  
wdpa_marine_all_file  <- file.path(dir_o_anx, 'wdpa/wdpa_mar_all_dec2017.tif')
wdpa_marine_i_vi_file <- file.path(dir_o_anx, 'wdpa/wdpa_mar_i_vi_dec2017.tif')
wdpa_marine_i_iv_file <- file.path(dir_o_anx, 'wdpa/wdpa_mar_i_iv_dec2017.tif')

if(!file.exists(wdpa_marine_all_file)) {
  wdpa_all_rast <- fasterize::fasterize(sf     = wdpa_marine, 
                                        raster = ocean_base,
                                        field  = 'STATUS_YR', 
                                        fun    = 'first')
  writeRaster(wdpa_all_rast, filename = wdpa_marine_all_file,
              overwrite = TRUE)
}

if(!file.exists(wdpa_marine_i_vi_file)) {
  wdpa_i_vi <- wdpa_marine %>%
    filter(IUCN_CAT %in% c('Ia', 'Ib', 'II', 'III', 'IV', 'V', 'VI'))
  
  wdpa_i_vi_rast <- fasterize::fasterize(sf = wdpa_i_vi, 
                                        raster = ocean_base,
                                        field = 'STATUS_YR', 
                                        fun = 'min')
  writeRaster(wdpa_i_vi_rast, filename = wdpa_marine_i_vi_file,
              overwrite = TRUE)
}

if(!file.exists(wdpa_marine_i_iv_file)) {
  wdpa_i_iv <- wdpa_marine %>%
    filter(IUCN_CAT %in% c('Ia', 'Ib', 'II', 'III', 'IV'))
  
  wdpa_i_iv_rast <- fasterize::fasterize(sf = wdpa_i_iv, 
                                        raster = ocean_base,
                                        field = 'STATUS_YR', 
                                        fun = 'min')
  writeRaster(wdpa_i_iv_rast, filename = wdpa_marine_i_iv_file,
              overwrite = TRUE)
}

```

## Create MEOW raster to match CHI base raster

Because the st_transform to Mollweide messes up on some of the ecoregions around +/- 180 degrees longitude, I will rasterize to a fine scale then transform the raster.  Since the AquaMaps data is only at half a degree, I should be able to go on the order of .05 degree without giving up too much relevant information.

``` {r project_meow_to_mollweide}

meow_poly <- read_sf(file.path(dir_o_anx, 
                               'meow/meow_ecos.shp')) %>%
  select(ECO_CODE)

base_rast_wgs84 <- raster::raster(ext = extent(-180, 180, -90, 90),
                          crs = CRS('+init=epsg:4326'),
                          resolution = .05)

meow_rast_file  <- file.path(dir_o_anx, 'meow/meow_rast_934m.tif')

if(!file.exists(meow_rast_file)) {
  meow_rast_wgs84 <- fasterize(meow_poly, base_rast_wgs84, 
                               field = 'ECO_CODE', fun = 'first')

  meow_rast_moll <- projectRaster(from     = meow_rast_wgs84, 
                                  to       = ocean_base,
                                  method   = 'ngb',
                                  progress = 'text',
                                  filename = meow_rast_file)

}

```

## Create latitude raster

``` {r create_latitude_rast}

lat_rast_file  <- file.path(dir_o_anx, 'spatial/latitude_rast.tif')

if(!file.exists(lat_rast_file)) {
  
  loiczid_lats <- read_csv(file.path(dir_o_anx, 'am_files', 'am_cells.csv')) %>%
    select(loiczid, lat = centerlat)
  
  loiczid_rast <- raster(file.path(dir_o_anx, 'spatial/loiczid_moll_934m.tif'))
  
  lat_rast <- loiczid_rast %>%
    subs(loiczid_lats, 
         progress = 'text',
         by = 'loiczid', which = 'lat', 
         filename = lat_rast_file)
}

```

## Create U(0, 1) raster and mask to oceans

``` {r create_uniform_random_rast}

rand_rast_file  <- file.path(dir_o_anx, 'spatial/rand_ocean_base.tif')

if(!file.exists(rand_rast_file)) {
  rand_rast <- ocean_base
  
  values(rand_rast) <- runif(ncell(rand_rast))
  
  rand_rast_ocean <- rand_rast %>%
    mask(ocean_base, filename = rand_rast_file)
}

```

-----

``` {r prov_footer, results = 'asis'}
prov_wrapup(commit_outputs = FALSE)
```

