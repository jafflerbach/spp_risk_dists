---
title: 'Aggregate IUCN spp ranges'
author: "*Compiled on `r date()` by `r Sys.info()['user']`*"
output: 
  html_document:
    code_folding: hide
    toc: true
    toc_depth: 3
    toc_float: yes
    number_sections: true
    theme: cerulean
    highlight: haddock
    includes: 
      in_header: '~/github/src/templates/ohara_hdr.html'
  pdf_document:
    toc: true
---

``` {r setup, echo = TRUE, message = FALSE, warning = FALSE}

knitr::opts_chunk$set(fig.width = 6, fig.height = 4, fig.path = 'Figs/',
                      echo = TRUE, message = FALSE, warning = FALSE)

library(raster)
source('https://raw.githubusercontent.com/oharac/src/master/R/common.R')

library(sf)
library(data.table)

dir_git <- '~/github/spp_risk_dists'
dir_o_anx <- file.path(dir_O, 'git-annex/spp_risk_dists')

source(file.path(dir_git, 'data_setup/api_fxns.R'))

### goal specific folders and info

dir_data <- file.path(dir_git, 'data')

```

# Summary

Using individual species range data (csv outputs from `5_process_spp_shps.Rmd`), collect into species groups.  In each species group, process range and risk information to get mean risk, variance of risk, species richness, and threatened species count per cell.  These will then be analyzed in the context of species range rarity weighting as well.

# Methods

## Generate species group maps - equal weighting per cell

From species maps data.frame, identify the IDs of species within each taxon.  For each taxon:

* Collect all taxon species into a single data.frame.
* Join species extinction risk and trend data.frame to species-cell data.frame, including regional assessments.
* By cell, calculate mean extinction risk, variance of extinction risk, trend, threatened species count, n_spp, n_spp_trend
    * When aggregating further, use n_spp to weight values.
    
__NOTE:__ Because the summary files are likely to be very large for globe-spanning taxa (e.g. MARINE_MAMMALS is 275 MB), save these outputs outside of GitHub.

``` {r aggregate species maps to taxa}

### Read in lots of data
spp_maps <- read_csv(file.path(dir_data, sprintf('spp_marine_maps_%s.csv', api_version)))

spp_risk <- read_csv(file.path(dir_data, sprintf('iucn_risk_current_%s.csv', api_version)))
spp_risk_rgn <- read_csv(file.path(dir_data, sprintf('iucn_risk_rgn_current_%s.csv', api_version)))

spp_trend <- read_csv(file.path(dir_data, sprintf('iucn_trend_by_spp_%s.csv', api_version))) %>%
  select(iucn_sid, trend_score, iucn_rgn)

### make a dataframe of species risk, trend, and regional risk
spp_risk_trend <- spp_risk %>%
  mutate(iucn_rgn = 'global') %>%
  bind_rows(spp_risk_rgn) %>%
  select(iucn_sid, iucn_rgn, cat_score) %>%
  left_join(spp_trend, by = c('iucn_sid', 'iucn_rgn'))

### Make a dataframe of cell ID to LME for regional assessments... also 
### make a lookup of LME to region
lme_rgns_rast <- raster::raster(file.path(dir_git, 'spatial', 'lme_rast_010_wgs84.tif'))
lme_cells_all <- data.frame(cell_id = 1:length(lme_rgns_rast),
                            lme_id = values(lme_rgns_rast)) %>%
  filter(!is.na(lme_id))
lme_to_rgn <- read_csv(file.path(dir_git, sprintf('data/iucn_rgn_to_lme_%s.csv', api_version))) %>%
  select(lme_id, rgn_name = rgns) %>%
  distinct()


### Make a list of taxonomic groups to loop over:
taxa <- spp_maps$dbf_file %>%
  unique() %>%
  str_replace('\\....$', '')


##########################################################.
### Looping over taxonomic groups -----
##########################################################.
for(taxon in taxa) {
  ### taxon <- taxa[1]
  
  taxon_risk_sum_file <- file.path(dir_o_anx, 'taxa_summaries',
                                   sprintf('%s_cell_sum_%s.csv', tolower(taxon), api_version))
  
  reload <- TRUE
  if(!file.exists(taxon_risk_sum_file) | reload == TRUE) {
    
    taxon_maps <- spp_maps %>%
      filter(str_detect(dbf_file, taxon))
    
    taxon_risk_trend <- spp_risk_trend %>%
      filter(iucn_sid %in% taxon_maps$iucn_sid) %>%
      filter(!is.na(cat_score)) %>%
      arrange(iucn_sid)
    
    ### Using the iucn_sid field, generate a vector of all species range files for
    ### this taxon.
    taxon_ids <- taxon_risk_trend$iucn_sid %>%
      unique()
    
    message('Processing ', length(taxon_ids), ' species maps in ', taxon, '...')

    ##########################################################.
    ### Looping over species within group -----
    ##########################################################.
    ### Collect all species ranges for this taxon into a single data.frame.
    ### Use mclapply since we're reading many large-ish files.  For MARINE_MAMMALS (85 assessed spp)
    ### this takes about 30-40 seconds
    taxon_cells_list <- parallel::mclapply(taxon_ids, mc.cores = 24,
                                        FUN = function(x) {
        ### x <- taxon_ids[1]
        ### x <- 6336                            
        csv_file <- file.path(dir_o_anx, 'spp_rasters', 
                              sprintf('iucn_sid_%s_010deg.csv', x))
        spp_risk_map <- read_csv(csv_file, col_types = 'di') %>%
          mutate(iucn_sid = x) %>%
          left_join(taxon_risk_trend, by = 'iucn_sid') 
        
        ### Identify regional assessments if any
        non_global_rgns <- lme_to_rgn %>%
            filter(rgn_name %in% spp_risk_map$iucn_rgn)
  
        if(nrow(non_global_rgns) > 0) {
          ### If any regional assessments, clip the LME cells down to the appropriate region...
          lme_cells <- lme_cells_all %>%
            inner_join(non_global_rgns, by = 'lme_id')
          ### ... then filter out non-matching overlapped cells
          spp_risk_map <- spp_risk_map %>%
            left_join(lme_cells, by = 'cell_id') %>%
            filter((iucn_rgn == 'global' & is.na(rgn_name)) | ### match global cells
                   (iucn_rgn == rgn_name))                    ### match region cells
        }
        
        ### select down to main columns; also, if presence == 5 (extinct), adjust category and trend scores.
        spp_risk_map <- spp_risk_map %>%
          select(cell_id, presence, iucn_sid, iucn_rgn, cat_score, trend_score) %>%
          distinct() %>%
          mutate(cat_score   = ifelse(presence == 5, 1, cat_score),
                 trend_score = ifelse(presence == 5, NA, trend_score))
        
        return(spp_risk_map)
      }) ### end of mclapply over all species in taxonomic group
  
    ##########################################################.
    ### Processing cell calculations for group -----
    ##########################################################.
  
    ### Set up for keyed data.table merging: key for iucn_sid, cell_id
    message('...binding rows to data.frame...')
    taxon_risk_map <- bind_rows(taxon_cells_list) ### this is pretty fast!
    
    message('...summarizing...')
    taxon_risk_summary <- taxon_risk_map %>%
      group_by(cell_id) %>%
      summarize(mean_risk   = mean(cat_score), ### NA categories already filtered out
                var_risk    = var(cat_score),
                n_spp_threatened = sum(cat_score >= 0.4 & cat_score < 1),  
                n_spp_risk  = n(),
                mean_trend  = mean(trend_score, na.rm = TRUE), ### not every species has a trend; na.rm = TRUE
                mean_trend  = ifelse(is.nan(mean_trend), NA, mean_trend),
                n_spp_trend = sum(!is.na(trend_score)))
    
    message('...writing file', taxon_risk_sum_file, '...')
    write_csv(taxon_risk_summary, taxon_risk_sum_file)

  } else { ### end of if statement checking whether file exists for this taxon
    message('Found file ', taxon_risk_sum_file, '... skipping process...')
  }
  
} ### end of taxonomic group loop
  
```

## Generate species group maps - range-rarity-weighted by cell

Same as above, except using range rarity as an indicator of endemism - species scores within a cell are weighted by the proportion of each species' range included within the cell.

* Determine species ranges using ocean-area data.frame and cell location data.frame.  Create an overall data.frame and save as .csv.
    * Compare to API values for EOO as a sanity check.  
    * Range map areas may not correspond well with EOO values - check this with Gina.
* Collect all taxon species into a single data.frame.
* Join species extinction risk and trend data.frame to species-cell data.frame, including regional assessments.
* By cell, calculate range-rarity-weighted mean extinction risk, variance of extinction risk, trend, threatened species count, rr_richness, rr_trend_richness (where rr_richness is range-rarity weighted species richness)
    * When aggregating further, use rr_richness to weight values.
    
__NOTE:__ as above, because the summary files are likely to be very large for globe-spanning taxa, save these outputs outside of GitHub.

``` {r calculate_ranges_from_range_maps}

spp_range_file <- file.path(dir_git, 'data',
                            sprintf('iucn_spp_range_area_%s.csv', api_version))

if(!file.exists(spp_range_file) | reload == TRUE) {
  ### load area raster, convert to data frame
  area_rast <- raster(file.path(dir_git, 'spatial/ocean_area_rast_010_wgs84.tif'))
  area_df <- data.frame(cell_id = 1:length(area_rast),
                        area_km2 = values(area_rast))
  
  ### load csvs of marine species range maps
  spp_maps <- read_csv(file.path(dir_data, sprintf('spp_marine_maps_%s.csv', api_version)))
  spp_ids <- spp_maps$iucn_sid %>%
    unique() %>%
    sort()
  
  # system.time({
  spp_range_list <- parallel::mclapply(spp_ids, mc.cores = 32,
                                       FUN = function(x) {  
    # x <- spp_ids[2]
    # x <- 4363
    spp_map <- read_csv(file.path(dir_o_anx, 'spp_rasters',
                                  sprintf('iucn_sid_%s_010deg.csv', x)),
                        col_types = 'di')
    
    spp_map_area <- spp_map %>%
      filter(presence != 5) %>% ### exclude extinct areas
      inner_join(area_df, by = 'cell_id')
    
    spp_range <- data.frame(iucn_sid  = x,
                            range_km2 = sum(spp_map_area$area_km2, na.rm = TRUE))
    return(spp_range)
  })
  # })
  
  spp_range_df <- bind_rows(spp_range_list) %>%
    left_join(spp_maps %>% 
                select(iucn_sid, sciname, dbf_file) %>%
                distinct(),
              by = 'iucn_sid')
  
  write_csv(spp_range_df, spp_range_file)
}

```

``` {r aggregate species maps to taxa by range rarity, eval = FALSE}

### Read in lots of data
spp_maps <- read_csv(file.path(dir_data, sprintf('spp_marine_maps_%s.csv', api_version)))

spp_risk <- read_csv(file.path(dir_data, sprintf('iucn_risk_current_%s.csv', api_version)))
spp_risk_rgn <- read_csv(file.path(dir_data, sprintf('iucn_risk_rgn_current_%s.csv', api_version)))

spp_trend <- read_csv(file.path(dir_data, sprintf('iucn_trend_by_spp_%s.csv', api_version))) %>%
  select(iucn_sid, trend_score, iucn_rgn)

### read in spp ranges and cell ocean areas for range rarity calcs
spp_ranges <- read_csv(spp_range_file)

area_rast <- raster(file.path(dir_git, 'spatial/ocean_area_rast_010_wgs84.tif'))
area_df <- data.frame(cell_id = 1:length(area_rast),
                      area_km2 = values(area_rast))

### make a dataframe of species risk, trend, and regional risk
spp_risk_trend <- spp_risk %>%
  mutate(iucn_rgn = 'global') %>%
  bind_rows(spp_risk_rgn) %>%
  select(iucn_sid, iucn_rgn, cat_score) %>%
  left_join(spp_trend, by = c('iucn_sid', 'iucn_rgn')) %>%
  left_join(spp_ranges, by = 'iucn_sid')

### Make a dataframe of cell ID to LME for regional assessments... also 
### make a lookup of LME to region
lme_rgns_rast <- raster::raster(file.path(dir_git, 'spatial', 'lme_rast_010_wgs84.tif'))
lme_cells_all <- data.frame(cell_id = 1:length(lme_rgns_rast),
                            lme_id = values(lme_rgns_rast)) %>%
  filter(!is.na(lme_id))
lme_to_rgn <- read_csv(file.path(dir_git, sprintf('data/iucn_rgn_to_lme_%s.csv', api_version))) %>%
  select(lme_id, rgn_name = rgns) %>%
  distinct()

### Make a list of taxonomic groups to loop over:
taxa <- spp_maps$dbf_file %>%
  unique() %>%
  str_replace('\\....$', '')


##########################################################.
### Looping over taxonomic groups -----
##########################################################.
for(taxon in taxa) {
  ### taxon <- taxa[15]
  
  taxon_risk_sum_file <- file.path(dir_o_anx, 'taxa_summaries',
                                   sprintf('%s_rarity_cell_sum_%s.csv', tolower(taxon), api_version))
  
  if(!file.exists(taxon_risk_sum_file)) {
    
    taxon_maps <- spp_maps %>%
      filter(str_detect(dbf_file, taxon))
    
    taxon_risk_trend <- spp_risk_trend %>%
      filter(iucn_sid %in% taxon_maps$iucn_sid) %>%
      filter(!is.na(cat_score)) %>%
      arrange(iucn_sid)
    
    ### Using the iucn_sid field, generate a vector of all species range files for
    ### this taxon.
    taxon_ids <- taxon_risk_trend$iucn_sid %>%
      unique()
    
    message('Processing ', length(taxon_ids), ' species maps in ', taxon, '...')

    ##########################################################.
    ### Looping over species within group -----
    ##########################################################.
    ### Collect all species ranges for this taxon into a single data.frame.
    ### Use mclapply since we're reading many large-ish files.  For MARINE_MAMMALS (85 assessed spp)
    ### this takes about 30-40 seconds
    taxon_cells_list <- parallel::mclapply(taxon_ids, mc.cores = 24,
                                        FUN = function(x) {
        ### x <- taxon_ids[1]
        ### x <- 6336                            
        csv_file <- file.path(dir_o_anx, 'spp_rasters', 
                              sprintf('iucn_sid_%s_010deg.csv', x))
        spp_risk_map <- read_csv(csv_file, col_types = 'di') %>%
          mutate(iucn_sid = x) %>%
          left_join(taxon_risk_trend, by = 'iucn_sid') 
        
        ### Identify regional assessments if any
        non_global_rgns <- lme_to_rgn %>%
            filter(rgn_name %in% y$iucn_rgn)
  
        if(nrow(non_global_rgns) > 0) {
          ### If any regional assessments, clip the LME cells down to the appropriate region...
          lme_cells <- lme_cells_all %>%
            inner_join(non_global_rgns, by = 'lme_id')
          ### ... then filter out non-matching overlapped cells
          spp_risk_map <- spp_risk_map %>%
            left_join(lme_cells, by = 'cell_id') %>%
            filter((iucn_rgn == 'global' & is.na(rgn_name)) | ### match global cells
                   (iucn_rgn == rgn_name))                    ### match region cells
        }
        
        ### select down to main columns; also, if presence == 5 (extinct), adjust category and trend scores.
        spp_risk_map <- spp_risk_map %>%
          select(cell_id, presence, iucn_sid, iucn_rgn, cat_score, trend_score) %>%
          distinct() %>%
          mutate(cat_score   = ifelse(presence == 5, 1, cat_score),
                 trend_score = ifelse(presence == 5, NA, trend_score))
        
        return(spp_risk_map)
      }) ### end of mclapply over all species in taxonomic group
  
    ##########################################################.
    ### Processing cell calculations for group -----
    ##########################################################.
  
    ### Set up for keyed data.table merging: key for iucn_sid, cell_id
    message('...binding rows to data.frame...')
    taxon_risk_map <- bind_rows(taxon_cells_list) ### this is pretty fast!
    
    message('...summarizing...')
    taxon_risk_summary <- taxon_risk_map %>%
      group_by(cell_id) %>%
      summarize(mean_risk   = mean(cat_score), ### NA categories already filtered out
                var_risk    = var(cat_score),
                n_spp_threatened = sum(cat_score >= 0.4 & cat_score < 1),  
                n_spp_risk  = n(),
                mean_trend  = mean(trend_score, na.rm = TRUE), ### not every species has a trend; na.rm = TRUE
                mean_trend  = ifelse(is.nan(mean_trend), NA, mean_trend),
                n_spp_trend = sum(!is.na(trend_score)))
    
    message('...writing file', taxon_risk_sum_file, '...')
    write_csv(taxon_risk_summary, taxon_risk_sum_file)

  } else { ### end of if statement checking whether file exists for this taxon
    message('Found file ', taxon_risk_sum_file, '... skipping process...')
  }
  
} ### end of taxonomic group loop
  
```
