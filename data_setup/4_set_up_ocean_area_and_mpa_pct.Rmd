---
title: 'Set up ocean area raster and MPA pct dataframe'
author: "*Compiled on `r date()` by `r Sys.info()['user']`*"
output: 
  html_document:
    code_folding: hide
    toc: true
    toc_depth: 3
    toc_float: yes
    number_sections: true
    theme: cerulean
    highlight: haddock
    includes: 
      in_header: '~/github/ohibc/src/templates/ohibc_hdr1.html'
  pdf_document:
    toc: true
---

``` {r setup, echo = TRUE, message = FALSE, warning = FALSE}

knitr::opts_chunk$set(fig.width = 6, fig.height = 4, fig.path = 'Figs/',
                      echo = TRUE, message = FALSE, warning = FALSE)

library(raster)
library(sf)
library(fasterize)

source('~/github/src/R/common.R')  ###
  ### includes library(tidyverse); library(stringr); dir_M points to ohi directory

dir_git <- '~/github/spp_health_dists'

### goal specific folders and info
dir_setup   <- file.path(dir_git, 'data_setup')
dir_spatial <- file.path(dir_git, 'spatial')
dir_anx     <- file.path(dir_M, 'git-annex')
dir_o_anx   <- file.path(dir_O, 'git-annex/spp_health_dists')
# ### provenance tracking
library(provRmd); prov_setup()

### support scripts
source('~/github/src/R/rast_tools.R') 
  ### raster plotting and analyzing scripts

ocean_base <- raster(file.path(dir_M, 'git-annex/globalprep/spatial/ocean.tif'))
### Note: this claims to have values 0 to 255...

```

# Summary

To define spatial areas more accurately, create rasters of WDPA and ocean area at CHI resolution (934m Mollweide).  These can then be resampled/aggregated back to tenth degree working rasters, summing the total ocean area and total protected area within each working cell.

* Ocean area - use ocean area raster from CHI and/or OHI as base for all other rasters
* LOICZID masked to ocean areas only
    * Raster values = protection level

# Data Sources

### WDPA

# Methods

## Ocean area raster

Use ocean raster from OHI assessments, match to 0.10 degree raster, crosstab to sum area in each 0.10 degree cell, then make a new raster of that... 
* note that area calculations for very northward cells may disagree due to weird geometry; replace only cells below 84째N (all above that should be pure ocean).  Compare value in ocean-only cells at various latitudes though to understand approximation error - approaching equator should be very close.
* this will be used to roughly calculate proportion of protected area in each tenth-degree cell; estimation error of MPA coverage should probably err in the same direction as total ocean area error.

### Create a tenth-degree cell raster to match CHI base raster

``` {r reproject_loiczid_to_mollweide}

tenthdeg_rast <- raster::raster(resolution = 0.10, ext = extent(c(-180, 180, -90, 90)))
### default to WGS84
values(tenthdeg_rast) <- 1:length(tenthdeg_rast)

tenthdeg_moll_file    <- file.path(dir_o_anx, 'spatial/tenthdeg_moll_ocean_934m.tif')
tenthdeg_moll_id_file <- file.path(dir_o_anx, 'spatial/tenthdeg_moll_id_934m.tif')

if(!file.exists(tenthdeg_moll_file)) {
  ### create bounding polygon for cropping the ID raster; use sp:: for interaction with raster
  globe_extents <- data.frame(long = rep(-180, times = 1801), lat = seq(-90, 90, .1)) %>%
    bind_rows(data.frame(long = seq(-180, 180, .1), lat = rep(90, times = 3601))) %>%
    bind_rows(data.frame(long = rep(180, times = 1801), lat = seq(90, -90, -.1))) %>%
    bind_rows(data.frame(long = seq(180, -180, -.1), lat = rep(-90, times = 3601))) %>%
    as.matrix()
    
  globe_poly <- sp::Polygon(globe_extents) %>% list(.) %>%
    sp::Polygons(., 1) %>% list(.) %>%
    sp::SpatialPolygons(., proj4string = raster::crs(tenthdeg_rast)) %>%
    sp::spTransform(., raster::crs(ocean_base))
  
  globe_poly_sf <- globe_poly %>% st_as_sf()
  globe_rast <- fasterize(globe_poly_sf, ocean_base)
  # plot(globe_poly)
  # plot(tenthdeg_moll)

  ### project the 0.10 deg lat-long raster to 934m Mollweide raster; mask with
  ### the globe polygon
  tenthdeg_moll <- projectRaster(from     = tenthdeg_rast,
                                 to       = ocean_base,
                                 progress = 'text',
                                 method   = 'ngb') %>%
    raster::mask(., globe_rast,
                 filename = tenthdeg_moll_id_file, 
                 overwrite = TRUE)
    
  
  ### mask to just ocean cells based on Cumulative Impacts ocean raster
  tenthdeg_moll_ocean <- raster::mask(tenthdeg_moll, ocean_base,
                                      filename = tenthdeg_moll_file, 
                                      overwrite = TRUE)
}

git_prov(tenthdeg_moll_id_file, 'output') ### mask() won't check provenance
git_prov(tenthdeg_moll_file, 'output')    ### mask() won't check provenance

```

### Aggregate ocean area back to 0.10째 raster

Area calculation in this manner has some error to it; but if we calculate a proportion then multiply it by the values from the `raster::area()` function later we should get fairly close approximation to ocean area.

``` {r}

tenthdeg_moll_ocean <- raster(tenthdeg_moll_file)
tenthdeg_moll_ids   <- raster(tenthdeg_moll_id_file)

tenthdeg_ocean_area_file <- file.path(dir_git, 'spatial', 'ocean_area_rast_010_wgs84.tif')

if(!file.exists(tenthdeg_ocean_area_file)) {

  # reso_km2 <- raster::res(tenthdeg_moll_ocean)[1] / 1000
  
  tenthdeg_ocean_df <- data.frame(cell_id  = values(tenthdeg_moll_ids),
                                  ocean_id = values(tenthdeg_moll_ocean))
  
  tenthdeg_area_df <- tenthdeg_ocean_df %>%
    group_by(cell_id) %>%
    summarize(total_cells = n(), 
              ocean_cells = sum(!is.na(ocean_id))) %>%
    mutate(ocean_area_prop = ocean_cells / total_cells)
  
  tenthdeg_rast_area <- data.frame(cell_id = values(tenthdeg_rast),
                                   cell_area_km2 = values(area(tenthdeg_rast)))
  
  ### above 84째N, set ocean area proportion to 1; below 84째S, set to 0.
  tenthdeg_area_df2 <- tenthdeg_area_df %>%
    full_join(tenthdeg_rast_area, by = 'cell_id') %>%
    mutate(ocean_area_prop = ifelse(cell_id < 216000,  1, ocean_area_prop),
           ocean_area_prop = ifelse(cell_id > 6264000, 0, ocean_area_prop),
           ocean_area_km2 = cell_area_km2 * ocean_area_prop) %>%
    select(cell_id, ocean_area_prop, cell_area_km2, ocean_area_km2) %>%
    filter(ocean_area_prop > 0)
 
  tenthdeg_area_rast <- tenthdeg_rast %>%
    subs(tenthdeg_area_df2, which = 'ocean_area_km2', by = 'cell_id')
  # plot(tenthdeg_area_rast)
  writeRaster(tenthdeg_area_rast, tenthdeg_ocean_area_file, overwrite = TRUE)
  
} else {
  git_prov(tenthdeg_ocean_area_file, 'output')
}

plot(raster(tenthdeg_ocean_area_file))
```

## Create WDPA MPA percent protection data frame

Marine regions are any protected area with MARINE flag of 1 or 2, or non-zero GIS_M_AREA.  Classify by IUCN category (I-VI -> 1-6; non-classified get 7).  Include only designated, adopted, and established parks.  Omit non-MPA management plans from U.S.  Rasterize to CHI resolution, calculate protected cells vs total cells to get percent of protection for each IUCN protection category.

Because we are rasterizing the protected areas down to the CHI raster resolution, we risk dropping any MPAs smaller than about 1 km^2.  We assume these are not likely to have a significant impact on biodiversity protection.

### Create WDPA map at Mollweide 934m resolution

``` {r project_wdpa_to_mollweide}

tenthdeg_moll_ocean <- raster(tenthdeg_moll_file)

wdpa_marine_file  <- file.path(dir_o_anx, 'wdpa/wdpa_mar_by_cat_jun2018.tif')

if(!file.exists(wdpa_marine_file)) {
  
  wdpa_poly <- read_sf(file.path(dir_o_anx, 'wdpa/wdpa_jun2018/WDPA_June2018-shapefile-polygons.shp'))

  # wdpa_poly$IUCN_CAT %>% unique()
  iucn_cats <- c('Ia'  = 1,
                 'Ib'  = 1,
                 'II'  = 2,
                 'III' = 3,
                 'IV'  = 4,
                 'V'   = 5,
                 'VI'  = 6)
  # wdpa_poly$STATUS %>% table()
       # Adopted   Designated  Established    Inscribed Not Reported     Proposed 
       #      34       215853            2          241          128         1537 
  
  wdpa_marine <- wdpa_poly %>%
    filter(MARINE > 0 | GIS_M_AREA > 0) %>%
    filter(STATUS %in% c('Designated', 'Adopted', 'Established')) %>%
      ### no paper parks
    filter(!str_detect(tolower(MANG_PLAN), 'non-mpa')) %>%
      ### omit non-MPA fisheries or species management plans
    mutate(cat = iucn_cats[IUCN_CAT],
           cat = ifelse(is.na(cat), 7, cat)) %>%
    arrange(cat) %>%
    st_transform(crs = proj4string(ocean_base))
  
  wdpa_all_rast <- fasterize::fasterize(sf     = wdpa_marine, 
                                        raster = ocean_base,
                                        field  = 'cat', 
                                        fun    = 'first')
  
  mask(wdpa_all_rast, tenthdeg_moll_ocean,
       filename = wdpa_marine_file,
       # progress = 'text',
       overwrite = TRUE)
}
  
git_prov(file.path(dir_o_anx, 'wdpa/wdpa_jun2018/WDPA_June2018-shapefile-polygons.shp'), 'input')
git_prov(wdpa_marine_file, 'output') ### even in "if", mask() won't prov-register it.

```

### Crosstab WDPA map to cell IDs

Be cautious when using `raster::crosstab()` as it returns factors that need to be coerced into integers... This code results in a file of cell IDs, IUCN protected area categories (1 = Ia and Ib, 2-6 = II - VI, 7 = other), and proportion of cell protected by that category.

``` {r crosstab mpa areas}

# wdpa_marine_file  <- file.path(dir_o_anx, 'wdpa/wdpa_mar_by_cat_jun2018.tif')
# tenthdeg_moll_file <- file.path(dir_o_anx, 'spatial/tenthdeg_moll_934m.tif')
# tenthdeg_ocean_area_file <- file.path(dir_o_anx, 'spatial', 'area_rast_010_wgs84.tif')

wdpa_all_rast       <- raster(wdpa_marine_file)
tenthdeg_ocean_rast <- raster(tenthdeg_moll_file)
tenthdeg_area_rast  <- raster(tenthdeg_ocean_area_file)

wdpa_cell_area_file <- file.path(dir_git, 'spatial/wdpa_mpa_area_010_wgs84.csv')

if(!file.exists(wdpa_cell_area_file)) {
  ### Break into smaller chunks for faster processing and eventual parallelizing
  n_chunks <- 30
  
  crosstab_chunk <- function(rast1, rast2, chunk, n_chunks) {
    ### chunk <- 1
    chunk_size <- ncol(rast1) / n_chunks
    left_bound <- (chunk - 1) * chunk_size + 1
    
    chunk_ext <- extent(rast1, 1, nrow(rast1), left_bound, left_bound + chunk_size)
    message('Processing ', chunk, ': ', paste0(as.character(round(chunk_ext)), collapse = ', '))
    wdpa_chunk    <- crop(rast1, chunk_ext)
    cell_id_chunk <- crop(rast2, chunk_ext)
    
    wdpa_cells <- crosstab(wdpa_chunk, cell_id_chunk, 
                                    progress = 'text',
                                    long = TRUE) %>%
      setNames(c('wdpa_category', 'cell_id', 'n_prot')) %>%
      mutate(wdpa_category = as.integer(as.character(wdpa_category)),
             cell_id       = as.integer(as.character(cell_id)))
        ### wdpa_category and cell_id are crosstabbed as factors - first
        ### convert to character (to unfactorize it) then to integer.  Otherwise
        ### you end up with factor index, not actual cell ID or category.
    
    return(wdpa_cells)
  }
  
  # system.time({
    wdpa_cells_list <- parallel::mclapply(1:n_chunks, 
                                          FUN = function(x) crosstab_chunk(wdpa_all_rast, 
                                                                           tenthdeg_ocean_rast, 
                                                                           chunk = x, n_chunks),
                                          mc.cores = 10)
  #     user   system  elapsed 
  # 1221.984 1340.792  410.808 
  # })
  
  wdpa_cells_df <- bind_rows(wdpa_cells_list)
  
  tenthdeg_area_df <- data.frame(cell_id  = values(tenthdeg_rast),
                                 area_km2 = values(tenthdeg_area_rast))
  
  reso_km2 <- raster::res(tenthdeg_ocean_rast)[1] / 1000
  
  wdpa_area_df <- wdpa_cells_df %>%
    full_join(tenthdeg_area_df) %>%
    filter(!is.na(wdpa_category)) %>%
    mutate(prot_area_km2 = n_prot * reso_km2^2,
           mpa_pct = prot_area_km2 / area_km2) %>%
    select(wdpa_category, cell_id, mpa_pct)
  
  write_csv(wdpa_area_df, wdpa_cell_area_file)
  
} else {
  git_prov(wdpa_cell_area_file, 'output')
}

```

### View WDPA protected area proportions as raster

Proportional protection can be multiplied by ocean area raster to get area of protection.  Collect by category (to avoid duplicate "by" values):

* No Take (categories 1 & 2 only)
* Conservation (categories 1-4)
* All protection (non-NA)

Note: these are not saved as rasters at this point... they are easily created from the dataframe of cell ID to protected proportion.

``` {r}

wdpa_area_df <- read_csv(wdpa_cell_area_file)

# tenthdeg_rast <- raster::raster(resolution = 0.10, ext = extent(c(-180, 180, -90, 90)))
# ### default to WGS84
# values(tenthdeg_rast) <- 1:length(tenthdeg_rast)

notake_df <- wdpa_area_df %>%
  filter(wdpa_category <= 2) %>%
  group_by(cell_id) %>%
  summarize(mpa_pct = sum(mpa_pct))

conservation_df <- wdpa_area_df %>%
  filter(wdpa_category <= 4) %>%
  group_by(cell_id) %>%
  summarize(mpa_pct = sum(mpa_pct))

all_prot_df <- wdpa_area_df %>%
  group_by(cell_id) %>%
  summarize(mpa_pct = sum(mpa_pct))

notake_raster <- subs(tenthdeg_rast, notake_df, by = 'cell_id', which = 'mpa_pct')
plot(notake_raster, main = 'No take protection (Ia, Ib, II)')
conservation_raster <- subs(tenthdeg_rast, conservation_df, by = 'cell_id', which = 'mpa_pct')
plot(conservation_raster, main = 'Conservation protection (Ia - IV)')
all_prot_raster <- subs(tenthdeg_rast, all_prot_df, by = 'cell_id', which = 'mpa_pct')
plot(all_prot_raster, main = 'All protection (any category)')
```

-----

``` {r prov_footer, results = 'asis'}
prov_wrapup(commit_outputs = FALSE)
```

