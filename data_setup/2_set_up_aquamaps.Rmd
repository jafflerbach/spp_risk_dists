---
title: 'Set up AquaMaps species distribution files'
author: "*Compiled on `r date()` by `r Sys.info()['user']`*"
output: 
  html_document:
    code_folding: hide
    toc: true
    toc_depth: 3
    toc_float: yes
    number_sections: true
    theme: cerulean
    highlight: haddock
    includes: 
      in_header: '~/github/src/templates/ohara_hdr.html'
  pdf_document:
    toc: true
---

``` {r setup, echo = TRUE, message = FALSE, warning = FALSE}

knitr::opts_chunk$set(fig.width = 6, fig.height = 4, fig.path = 'Figs/',
                      echo = TRUE, message = FALSE, warning = FALSE)

library(raster)

source('https://raw.githubusercontent.com/oharac/src/master/R/common.R')

dir_git <- '~/github/spp_health_dists'

dir_am_data <- file.path(dir_M, 'git-annex/globalprep/_raw_data/aquamaps/d2017')

### goal specific folders and info
dir_setup   <- file.path(dir_git, 'data_setup')
dir_data    <- file.path(dir_git, 'data')
dir_o_anx <- file.path(dir_O, 'git-annex/spp_health_dists')
# ### provenance tracking
library(provRmd); prov_setup()

### support scripts
source('~/github/src/R/rast_tools.R') 
  ### raster plotting and analyzing scripts

```

# Summary

Set up AquaMaps distributions for species with IUCN threat assessments.

* Identify AquaMaps species with valid IUCN threat assessments, and carve down the AM dataset to just these.
* Set up AquaMaps LOICZID raster for mapping and analysis
* Clean up AquaMaps species-to-cell lookup to include only IUCN-categorized species, and convert CSquareCode values to LOICZID values.

# Data Sources

### AquaMaps

# Methods

## Identify AquaMaps species with valid IUCN risk assessments

Gets the most recent IUCN API version and looks for those files.  If those files are not present, will not run properly; run `1_set_up_iucn_risk.Rmd` to get latest values.

``` {r join_health_to_am_list}

api_version <- jsonlite::fromJSON('http://apiv3.iucnredlist.org/api/v3/version') %>%
  .$version

spp_timeseries_file <- file.path(dir_git, 'data',
                                 sprintf('iucn_risk_timeseries_%s.csv', api_version))

spp_cat_current_file <- file.path(dir_git, 'data', 
                              sprintf('iucn_risk_current_%s.csv', api_version))

spp_current_ts <- read_csv(spp_timeseries_file) %>%
  group_by(iucn_sid) %>%
  filter(year == max(year)) %>%
  select(iucn_sid, cat_ts, cat_ts_score)

spp_current <- read_csv(spp_cat_current_file) %>%
  filter(!is.na(iucn_sid)) %>%
  full_join(spp_current_ts) %>%
  mutate(cat       = ifelse(is.na(cat), cat_ts, cat),
         cat_score = ifelse(is.na(cat_score), cat_ts_score, cat_score)) %>%
  select(iucn_sid, sciname, main_common_name, cat, cat_score) %>%
  distinct()

am_all <- read_csv(file.path(dir_am_data, 'csv', 'speciesoccursum.csv'))

am_with_scores <- am_all %>%
  clean_df_names() %>%
  select(am_sid = speciesid, am_g = genus, am_s = species, iucn_sid = iucn_id) %>%
  inner_join(spp_current, by = c('iucn_sid')) %>%
  mutate(sciname = ifelse(is.na(sciname), paste(am_g, am_s, sep = ' '), sciname)) %>%
  select(-am_g, -am_s) %>%
  distinct()

write_csv(am_with_scores, file.path(dir_setup, 'int/am_with_scores.csv'))
  
```

## Set up AquaMaps LOICZID raster

This chunk sets up the LOICZID raster based on the AquaMaps HCAF file.

``` {r set up loiczid raster}

loiczid_rast_file <- file.path(dir_git, 'spatial/loiczid_raster.tif')

if(!file.exists(loiczid_rast_file)) {
  am_cells <- data.table::fread(file.path(dir_am_data, 'csv', 'hcaf_v6.csv'),
                                select = c('LOICZID', 'CenterLat', 'CenterLong')) %>%
    clean_df_names() %>%
    rename(x = centerlong, y = centerlat, value = loiczid)
  git_prov(file.path(dir_am_data, 'csv', 'hcaf_v6.csv'), filetype = 'input')
  
  loiczid_rast <- rasterFromXYZ(am_cells, crs = CRS('+init=epsg:4326'))
  
  writeRaster(loiczid_rast, loiczid_rast_file)
} else {
  message('LOICZID raster exists: \n  ', loiczid_rast_file)
  git_prov(file.path(dir_am_data, 'csv', 'hcaf_v6.csv'), filetype = 'input')
  git_prov(loiczid_rast_file, filetype = 'output')
}

```

## Set up AquaMaps Species-Cell lookup

This chunk takes the full AquaMaps species-cell lookup, cell ID lookup, and AM-to-IUCN category lookup, and creates a cleaned file of AquaMaps species-cells by LOICZID for only those species with valid IUCN categories.

``` {r get_loiczid_for_scored_spp}

am_spp_cells_file <- file.path(dir_o_anx, 'am_files', 'am_spp_cells.csv')

if(!file.exists(am_spp_cells_file)) {
  library(data.table)

  am_cells <- data.table::fread(file.path(dir_am_data, 'csv', 'hcaf_v6.csv'),
                                select = c('CsquareCode', 'LOICZID', 'CenterLat',
                                           'CenterLong', 'CellArea', 'OceanArea', 'PWater')) %>%
    clean_df_names() %>%
    distinct()
  
  am_spp_cells <- data.table::fread(file.path(dir_am_data, 'csv', 'hcaf_species_native.csv')) %>%
    clean_df_names()
  
  git_prov(file.path(dir_am_data, 'csv', 'hcaf_v6.csv'), filetype = 'input')
  git_prov(file.path(dir_am_data, 'csv', 'hcaf_species_native.csv'), filetype = 'input')

  am_with_scores <- read_csv(file.path(dir_setup, 'int/am_with_scores.csv'))
  
  am_spp_cells_scored <- am_spp_cells %>%
    filter(speciesid %in% am_with_scores$am_sid) 
  
  ### using data.table join x[y, on = (key)] as left_join(y, x)...
  asc_loiczid <- am_cells[am_spp_cells_scored, on = 'csquarecode'] %>%
    select(am_sid = speciesid, loiczid, prob = probability)
  
  write_csv(asc_loiczid, file.path(dir_o_anx, 'am_files', 'am_spp_cells.csv'))
} else {
  
  message('AquaMaps cleaned spp-cell lookup file exists: \n  ', am_spp_cells_file)
  git_prov(file.path(dir_am_data, 'csv', 'hcaf_v6.csv'), filetype = 'input')
  git_prov(file.path(dir_am_data, 'csv', 'hcaf_species_native.csv'), filetype = 'input')
  git_prov(am_spp_cells_file, filetype = 'output')
  
}

```

## Species ranges

Species range may be used in a couple of different ways:

* a rough filter to separate species by overall range
* to calculate range rarity and relative range rarity
    * this may also be useful in the SPP goal - i.e. rather than area-weighting species within an EEZ, use a range rarity weighting?
        * this basically gives priority to species in an EEZ who don't live anywhere else
        * maybe there is a min threshold for range rarity so global species (e.g. whales, tuna) don't completely drop out of the calcs
        * global species could also be weighted based on range rarity calculated only within EEZs (i.e. don't count high seas cells in the range area)
        
To determine this, we can look at a few options:

* range counting all cells equally, for 0% threshold and 60% threshold
* range counting all cells by their probability of occurrence, e.g. a 1% cell with 2000 km^2 area only adds 20 km^2 to the calculation

``` {r spp_range}

am_spp_cells_file <- file.path(dir_o_anx, 'am_files', 'am_spp_cells.csv')

am_cells <- data.table::fread(file.path(dir_am_data, 'csv', 'hcaf_v6.csv'),
                              select = c('LOICZID', 'CellArea', 'OceanArea', 'PWater')) %>%
  clean_df_names() %>%
  distinct()

am_spp_cells_areas <- data.table::fread(am_spp_cells_file) %>%
  left_join(am_cells, by = 'loiczid')

am_range_0_pct <- am_spp_cells_areas %>%
  filter(prob >= 0) %>%
  group_by(am_sid) %>%
  summarize(area_km2_0pct = sum(oceanarea))

am_range_60_pct <- am_spp_cells_areas %>%
  filter(prob >= .60) %>%
  group_by(am_sid) %>%
  summarize(area_km2_60pct = sum(oceanarea))

am_range_probwt <- am_spp_cells_areas %>%
  group_by(am_sid) %>%
  summarize(area_km2_probwt = sum(oceanarea * prob))

am_range_summary <- am_range_0_pct %>%
  left_join(am_range_60_pct, by = 'am_sid') %>%
  left_join(am_range_probwt, by = 'am_sid')

ggplot(am_range_summary %>%
         gather(calc, area, contains('area_km2'))) +
  ggtheme_plot() +
  geom_density(aes(x = area, color = calc)) +
  xlim(c(0, 5e7))

am_range_summary %>% summary()

write_csv(am_range_summary, file.path(dir_git, 'data', 'am_spp_range_summary.csv'))
```

## Species taxa

Use taxonomic data from AquaMaps to divide the species up for further analysis.

``` {r plot_distr_of_spp_range}

am_taxa <- read_csv(file.path(dir_am_data, 'csv', 'speciesoccursum.csv')) %>%
  clean_df_names() %>%
  mutate(sciname = paste(str_trim(genus), str_trim(species))) %>%
  select(am_sid = speciesid, sciname, common_name = fbname, 
         kingdom, phylum, class, iucn_sid = iucn_id) %>%
  distinct()

am_taxa_sum <- am_taxa %>% 
  group_by(kingdom, phylum) %>%
  summarize(n_spp = n())

chordata_sum <- am_taxa %>%
  filter(phylum == 'Chordata') %>%
  group_by(class) %>%
  summarize(n_spp = n())

taxa_groups <- am_taxa %>%
  select(kingdom, phylum, class) %>%
  distinct() %>%
  mutate(taxa = case_when(kingdom == 'Plantae'  ~ 'plant',
                          kingdom != 'Animalia' ~ 'bact/chrom/proto',
                          phylum != 'Chordata'  ~ 'invertebrate', 
                            ### note: one blank phylum that seems to be a fish?
                          class == 'Mammalia'   ~ 'mammal',
                          class == 'Aves'       ~ 'bird',
                          str_detect(class, 'Actin|Sarc')    ~ 'bony fish',
                          str_detect(class, 'Elasmo|Holo')   ~ 'cart fish',
                          str_detect(class, 'Rept|Amph')     ~ 'rept amph',
                          TRUE ~ 'other vertebrate'))
  
am_taxa_sum1 <- am_taxa %>%
  left_join(taxa_groups, by = c('kingdom', 'phylum', 'class'))

write_csv(am_taxa_sum1, file.path(dir_data, 'am_spp_taxa.csv'))
```

-----

``` {r prov_footer, results = 'asis'}
prov_wrapup(commit_outputs = FALSE)
```

