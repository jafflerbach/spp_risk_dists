---
title: 'Set up AquaMaps species distribution files'
author: "*Compiled on `r date()` by `r Sys.info()['user']`*"
output: 
  html_document:
    code_folding: hide
    toc: true
    toc_depth: 3
    toc_float: yes
    number_sections: true
    theme: cerulean
    highlight: haddock
    includes: 
      in_header: '~/github/src/templates/ohara_hdr.html'
  pdf_document:
    toc: true
---

``` {r setup, echo = TRUE, message = FALSE, warning = FALSE}

knitr::opts_chunk$set(fig.width = 6, fig.height = 4, fig.path = 'Figs/',
                      echo = TRUE, message = FALSE, warning = FALSE)

library(raster)

source('https://raw.githubusercontent.com/oharac/src/master/R/common.R')

dir_git <- '~/github/spp_health_dists'

dir_am_data <- file.path(dir_M, 'git-annex/globalprep/_raw_data/aquamaps/d2017')

### goal specific folders and info
dir_setup   <- file.path(dir_git, 'data_setup')
dir_data    <- file.path(dir_git, 'data')
dir_o_anx <- file.path(dir_O, 'git-annex/spp_health_dists')
# ### provenance tracking
library(provRmd); prov_setup()

### support scripts
source('~/github/src/R/rast_tools.R') 
  ### raster plotting and analyzing scripts

```

# Summary

Set up AquaMaps distributions for species with IUCN threat assessments.

* Identify AquaMaps species with valid IUCN threat assessments, and carve down the AM dataset to just these.
* Set up AquaMaps LOICZID raster for mapping and analysis
* Clean up AquaMaps species-to-cell lookup to include only IUCN-categorized species, and convert CSquareCode values to LOICZID values.

# Data Sources

### AquaMaps

# Methods

## Identify AquaMaps species with valid IUCN risk assessments

``` {r join_health_to_am_list}

spp_timeseries_file <- file.path(dir_git, 'data', 'iucn_spp_cat_timeseries.csv')

spp_cat_current_file <- file.path(dir_git, 'data', 'iucn_spp_cat_current.csv')

spp_current_ts <- read_csv(spp_timeseries_file) %>%
  group_by(iucn_sid) %>%
  filter(year == max(year)) %>%
  select(iucn_sid, old_cat, cat = cat_ts, cat_score)

spp_current <- read_csv(spp_cat_current_file) %>%
  filter(!is.na(iucn_sid)) %>%
  full_join(spp_current_ts)

am_all <- read_csv(file.path(dir_am_data, 'csv', 'speciesoccursum.csv'))

am_with_scores <- am_all %>%
  clean_df_names() %>%
  select(am_sid = speciesid, am_g = genus, am_s = species, iucn_id, iucn_code) %>%
  left_join(spp_current, by = c('iucn_id' = 'iucn_sid', 'iucn_code' = 'cat')) %>%
  filter(!is.na(iucn_id) | !is.na(iucn_code)) %>%
  filter(iucn_code != 'N.E.' & iucn_code != 'DD') %>%
  distinct()

write_csv(am_with_scores, file.path(dir_setup, 'int/am_with_scores.csv'))
  
```

## Set up AquaMaps LOICZID raster

This chunk sets up the LOICZID raster.

``` {r set up loiczid raster}

loiczid_rast_file <- file.path(dir_git, 'spatial/loiczid_raster.tif')

if(!file.exists(loiczid_rast_file)) {
  am_cells <- data.table::fread(file.path(dir_am_data, 'csv', 'hcaf_v6.csv')) %>%
    select(LOICZID, CenterLat, CenterLong) %>%
    clean_df_names() %>%
    select(x = centerlong, y = centerlat, value = loiczid)
  git_prov(file.path(dir_am_data, 'csv', 'hcaf_v6.csv'), filetype = 'input')
  
  loiczid_rast <- rasterFromXYZ(am_cells, crs = CRS('+init=epsg:4326'))
  
  writeRaster(loiczid_rast, loiczid_rast_file)
} else {
  message('LOICZID raster exists: \n  ', loiczid_rast_file)
  git_prov(file.path(dir_am_data, 'csv', 'hcaf_v6.csv'), filetype = 'input')
  git_prov(loiczid_rast_file, filetype = 'output')
  
}

```

## Set up AquaMaps Species-Cell lookup

This chunk takes the full AquaMaps species-cell lookup, cell ID lookup, and AM-to-IUCN category lookup, and creates a cleaned file of AquaMaps species-cells by LOICZID for only those species with valid IUCN categories.


``` {r get_loiczid_for_scored_spp}

am_spp_cells_file <- file.path(dir_o_anx, 'am_files', 'am_spp_cells.csv')

if(!file.exists(am_spp_cells_file)) {
  library(data.table)

  am_cells <- data.table::fread(file.path(dir_am_data, 'csv', 'hcaf_v6.csv')) %>%
    select("CsquareCode", "LOICZID", "CenterLat", "CenterLong", "CellArea", 
           "OceanArea", "PWater") %>%
    clean_df_names() %>%
    distinct()
  
  am_spp_cells <- data.table::fread(file.path(dir_am_data, 'csv', 'hcaf_species_native.csv')) %>%
    clean_df_names()
  
  git_prov(file.path(dir_am_data, 'csv', 'hcaf_v6.csv'), filetype = 'input')
  git_prov(file.path(dir_am_data, 'csv', 'hcaf_species_native.csv'), filetype = 'input')

  am_with_scores <- read_csv(file.path(dir_setup, 'int/am_with_scores.csv'))
  
  am_spp_cells_scored <- am_spp_cells %>%
    filter(speciesid %in% am_with_scores$am_sid) 
  
  ### using data.table join x[y, on = (key)] as left_join(y, x)...
  asc_loiczid <- am_cells[am_spp_cells_scored, on = 'csquarecode'] %>%
    select(am_sid = speciesid, loiczid, prob = probability)
  
  write_csv(asc_loiczid, file.path(dir_o_anx, 'am_files', 'am_spp_cells.csv'))
} else {
  
  message('AquaMaps cleaned spp-cell lookup file exists: \n  ', am_spp_cells_file)
  git_prov(file.path(dir_am_data, 'csv', 'hcaf_v6.csv'), filetype = 'input')
  git_prov(file.path(dir_am_data, 'csv', 'hcaf_species_native.csv'), filetype = 'input')
  git_prov(am_spp_cells_file, filetype = 'output')
  
}

```

## Species ranges

A rough filter based on total ocean area of species range could be useful to exclude species whose range is essentially ocean-basin-wide.  Since IUCN scores are equal over the entire range, it is difficult to see any effect of species risk from very localized pressures.

``` {r spp_range}

am_spp_cells_file <- file.path(dir_o_anx, 'am_files', 'am_spp_cells.csv')

am_spp_cells <- read_csv(am_spp_cells_file)

am_cells <- data.table::fread(file.path(dir_am_data, 'csv', 'hcaf_v6.csv')) %>%
  select("LOICZID", "CellArea", "OceanArea", "PWater") %>%
  clean_df_names() %>%
  distinct()

am_range_summary <- am_spp_cells %>%
  filter(prob >= .60) %>%
  left_join(am_cells, by = 'loiczid') %>%
  group_by(am_sid) %>%
  summarize(area_km2 = sum(oceanarea),
            log_area = log(area_km2))

# quantile(am_range_summary$area_km2, c(0.01, 0.10, 0.25, 0.50, 0.75, 0.90, 0.95, 0.99)) %>% round(-3)
#        1%       10%       25%       50%       75%       90%       95%       99% 
#     26000    188000    455000   1701000   5487000   8369000  11209000 127676000 
       
# max(am_range_summary$area_km2)
#   245559322

ggplot(am_range_summary) +
  ggtheme_plot() +
  geom_density(aes(x = area_km2)) +
  geom_vline(xintercept = 15000000, color = 'red', alpha = .5)

ggplot(am_range_summary) +
  ggtheme_plot() +
  geom_density(aes(x = log_area)) +
  geom_vline(xintercept = log(15000000), color = 'red', alpha = .5)

am_with_scores <- read_csv(file.path(dir_setup, 'int/am_with_scores.csv'))

am_range_summary <- am_range_summary %>%
  left_join(am_with_scores %>% select(am_sid, iucn_sid = iucn_id, sciname, iucn_code),
            by = 'am_sid')
  
write_csv(am_range_summary, file.path(dir_git, 'data', 'am_spp_range_summary.csv'))
```

## Species taxa

``` {r plot_distr_of_spp_range}

am_spp_cells_file <- file.path(dir_o_anx, 'am_files', 'am_spp_cells.csv')

am_spp_cells <- read_csv(am_spp_cells_file)

am_taxa <- read_csv(file.path(dir_am_data, 'csv', 'speciesoccursum.csv')) %>%
  clean_df_names() %>%
  mutate(sciname = paste(str_trim(genus), str_trim(species))) %>%
  select(am_sid = speciesid, sciname, common_name = fbname, 
         kingdom, phylum, class, iucn_sid = iucn_id) %>%
  distinct()

am_taxa_sum <- am_taxa %>% 
  group_by(kingdom, phylum) %>%
  summarize(n_spp = n())

chordata_sum <- am_taxa %>%
  filter(phylum == 'Chordata') %>%
  group_by(class) %>%
  summarize(n_spp = n())

taxa_groups <- am_taxa %>%
  select(kingdom, phylum, class) %>%
  distinct() %>%
  mutate(taxa = case_when(kingdom == 'Plantae'  ~ 'plant',
                          kingdom != 'Animalia' ~ 'bact/chrom/proto',
                          phylum != 'Chordata'  ~ 'invertebrate', 
                            ### note: one blank phylum that seems to be a fish?
                          class == 'Mammalia'   ~ 'mammal',
                          class == 'Aves'       ~ 'bird',
                          str_detect(class, 'Actin|Sarc')    ~ 'bony fish',
                          str_detect(class, 'Elasmo|Holo')   ~ 'cart fish',
                          str_detect(class, 'Rept|Amph')     ~ 'rept/amph',
                          TRUE ~ 'other vertebrate'))
  
am_taxa_sum1 <- am_taxa %>%
  left_join(taxa_groups, by = c('kingdom', 'phylum', 'class'))

write_csv(am_taxa_sum1, file.path(dir_data, 'am_spp_taxa.csv'))
```

-----

``` {r prov_footer, results = 'asis'}
prov_wrapup(commit_outputs = FALSE)
```

