---
title: 'Biodiversity intactness maps - range-rarity weighting'
author: "*Compiled on `r date()` by `r Sys.info()['user']`*"
output: 
  html_document:
    code_folding: hide
    toc: true
    toc_depth: 3
    toc_float: yes
    number_sections: true
    theme: cerulean
    highlight: haddock
    includes: 
      in_header: '~/github/ohibc/src/templates/ohibc_hdr1.html'
  pdf_document:
    toc: true
---

``` {r setup, echo = TRUE, message = FALSE, warning = FALSE}

knitr::opts_chunk$set(fig.width = 6, fig.height = 4, fig.path = 'Figs/',
                      echo = TRUE, message = FALSE, warning = FALSE)

library(raster)
library(data.table)


source('https://raw.githubusercontent.com/oharac/src/master/R/common.R')  ###
  ### includes library(tidyverse); library(stringr); dir_M points to ohi directory

dir_git <- '~/github/spp_risk_dists'

### goal specific folders and info
dir_setup <- file.path(dir_git, 'data_setup')
dir_data  <- file.path(dir_git, 'data')
dir_o_anx <- file.path(dir_O, 'git-annex/spp_risk_dists')

source(file.path(dir_git, 'data_setup/api_fxns.R'))

```

# Summary

Create a set of maps of the distribution of biodiversity intactness - all species assessed and mapped by IUCN.  These maps are generated at 0.10Â° lat/long resolution.  All values are calculated based on range rarity, i.e. a cell's value depends on the status and relative proportion of range of each species present in the cell.  These maps will be generated using all available species:

* Mean risk
* Variance of risk
* Number of species for mean/var calculations
* Number of species categorized as "threatened" (i.e. VU, EN, CR)
* Mean trend
* Number of species for trend calculations
    
A selection of these maps will be generated for taxonomic groups and range sizes in a separate Rmd.

# Data Sources

IUCN Red List spatial data download
IUCN Red List API
Gina Ralph (IUCN)

# Methods

## Spatial distribution of range-rarity-weighted current extinction risk

### Aggregate mean risk and variance by cell

In data_setup we have calculated, for each taxonomic group, cell values for mean risk, var risk, and mean trend, as well as  range-rarity-weighted species richness (sr_rr) for risk, threatened, and trend.  Here we bring those data frames all together to calculate these values across all assessed species.

Because of file sizes, the intermediate files will be stored outside of GitHub.

``` {r create_cell_value_df_for_all_spp}

dir_taxa_summaries <- file.path(dir_o_anx, 'taxa_summaries')
sum_files <- list.files(dir_taxa_summaries,
                        pattern = sprintf('cell_sum_rrweight_%s.csv', api_version),
                        full.names = TRUE)

########################################################.
###      Read in all files and bind to df          #####
########################################################.
message('going into the first mclapply...')

# check_cols <- parallel::mclapply(sum_files, mc.cores = 25,
#                                       FUN = function(x) { ### x <- sum_files[2]
#                                         y <- read_csv(x, n_max = 1)
#                                         z <- data.frame('sum_file' = x, 'columns' = names(y))
#                                         }
#                                       ) %>%
#   bind_rows() %>%
#   group_by(sum_file) %>%
#   mutate(n_cols = n())

ptm <- proc.time()
cell_values_all <- parallel::mclapply(sum_files, mc.cores = 16,
                                      FUN = function(x) { ### x <- sum_files[2]
                                        y <- read_csv(x, col_types = 'ddddddd')
                                        }
                                      ) %>%
  setNames(basename(sum_files)) %>%
  bind_rows(.id = 'sum_file')
proc.time() - ptm ### 52 sec when using 16 cores...
cat('... processing time ', (proc.time() - ptm)[3], ' sec')

### Check no NAs in mean_risk - this is a problem with integer/double in range calculations.  UGGGHHHHH
### cell_values_all %>% filter(is.na(mean_risk)) %>% .$sum_file %>% unique()


########################################################.
###      Break into chunks for convenience         #####
########################################################.
### chunk into smaller bits for mclapply usage.  Use mclapply to chunk in the first place!
### then pass result to mclapply to calculate weighted average values
chunksize  <- 100000
cell_ids  <- cell_values_all$cell_id %>% unique()
n_chunks <- ceiling(length(cell_ids) / chunksize)

message('going into the second mclapply...')
  ### standard:  3 sec for 5, 12.5 sec for 20... 32 sec for 50... 479 chunks ~ 6 min.
  ### mclapply: 20 sec for 32, with 16 cores.
ptm <- proc.time()
cell_vals_list <- parallel::mclapply(1:n_chunks,
    mc.cores = 12,
    FUN = function(x) { ### x <- 3
      btm_i <- (x - 1) * chunksize + 1
      top_i <- min(x * chunksize, length(cell_ids))
      ids <- cell_ids[btm_i:top_i]
      
      df <- cell_values_all %>%
       filter(cell_id %in% ids)
      
      return(df)
}) ### end of mclapply 2
proc.time() - ptm ### 20 sec when using 25 cores...
cat('... processing time ', (proc.time() - ptm)[3], ' sec')

########################################################.
###     Process chunks into means and whatnot      #####
########################################################.

message('going into the third mclapply...')

ptm <- proc.time() ### 514 sec standard; 22.4 sec mclapply with 32 cores.
cell_summary_list <- parallel::mclapply(cell_vals_list, mc.cores = 16,
                                   FUN = function(x) {
  ### x <- cell_vals_list[[1]]
  y <- x %>%
    group_by(cell_id) %>%
    summarize(mean_risk   = sum(mean_risk * sr_rr_risk) / sum(sr_rr_risk),
              # var_risk    = sum(var_risk * (sr_rr_risk - 1), na.rm = TRUE) / sum(sr_rr_risk - 1),
                ### https://en.wikipedia.org/wiki/Pooled_variance BUT:
                ### this is probably wrong when we are organizing by range rarity rather than N.
                ### look into it further!
              sr_rr_risk  = sum(sr_rr_risk),
              sr_rr_threatened = sum(sr_rr_threatened, na.rm = TRUE),
              pct_rr_threatened   = sr_rr_threatened / sr_rr_risk,
              mean_trend  = sum(mean_trend * sr_rr_trend, na.rm = TRUE) / sum(sr_rr_trend, na.rm = TRUE),
              sr_rr_trend = sum(sr_rr_trend, na.rm = TRUE))
  }) ### end of mclapply 3
# })
proc.time() - ptm ### 20 sec when using 25 cores...
message('... processing time ', (proc.time() - ptm)[3], ' sec')
message('done!')

cell_summary <- cell_summary_list %>%
  bind_rows()

### first 3600 cells (northern most row) all identical; sr_rr_risk = 6.017160e-09
### cell 2658371 sr_rr_risk = 5.1235720  mean rr-weighted risk = 6.054929e-02
### cell 2640371 sr_rr_risk = 2.41540854 mean rr-weighted risk = 0.260718927  
###              sr_rr_threatened = 2.352185e+00  pct_rr_threatened = 9.738251e-01

# asdf <- cell_values_all %>% filter(cell_id %in% c(3600, 2658371, 2640371, 3526058, 4003402))
### conus drives the high sr_rr_risk on both 2658371, 2640371
### 3526058 is based on quite a few species with moderate (> 0.1) range rarity totals
### 4003402 based on angelfish and wrasse

### at spp-cell level, mean_risk = mean(cat_score * range_rarity)
### at taxa-cell level, mean_risk = sum(mean_risk * taxa_rr) / sum(taxa_rr)
```

### And now, the maps

``` {r mean_risk_raster}

rast_base <- raster(ext = extent(c(-180, 180, -90, 90)), res = 0.1)
values(rast_base) <- 1:length(rast_base)

mean_rast <- subs(rast_base, cell_summary, by = 'cell_id', which = 'mean_risk')
writeRaster(mean_rast, file.path(dir_git, 'output', 'mean_rr_risk_raster_010deg.tif'),
            overwrite = TRUE)

### mean_rast <- raster(file.path(dir_git, 'output', 'mean_rr_risk_raster_010deg.tif'))

mean_df <- mean_rast %>% 
  rasterToPoints() %>% 
  as.data.frame() %>%
  setNames(c('long', 'lat', 'value'))

message('ggplotting the global map...')

ggplot(mean_df, aes(long, lat, fill = value)) +
  geom_raster() +
  ggtheme_plot() +
  theme(axis.text = element_blank(), 
        axis.title = element_blank()) +
  scale_fill_gradientn(colors = c('green3', 'yellow', 'red3', 'purple4'),
                       values = c(0, .25, .5, 1)) +
  coord_fixed() +
  labs(title = 'Mean risk, range-rarity weighted',
       fill  = 'mean(risk)')

message('now ggplotting the regional maps...')

ggplot(mean_df, aes(long, lat, fill = value)) +
  geom_raster() +
  ggtheme_plot() +
  theme(axis.text = element_blank(), 
        axis.title = element_blank()) +
  scale_fill_gradientn(colors = c('green3', 'yellow', 'red3', 'purple4'),
                       values = c(0, .25, .5, 1)) +
  xlim(c(-180, -110)) + ylim(c(30, 63)) +
  coord_fixed() +
  labs(title = 'Mean risk (NE Pacific), range-rarity weighted',
       fill  = 'mean(risk)')

ggplot(mean_df, aes(long, lat, fill = value)) +
  geom_raster() +
  ggtheme_plot() +
  theme(axis.text = element_blank(), 
        axis.title = element_blank()) +
  scale_fill_gradientn(colors = c('green3', 'yellow', 'red3', 'purple4'),
                       values = c(0, .25, .5, 1)) +
  xlim(c(-20, 45)) + ylim(c(28, 48)) +
  coord_fixed() +
  labs(title = 'Mean risk (Mediterranean), range-rarity weighted',
       fill  = 'mean(risk)')
  
ggplot(mean_df, aes(long, lat, fill = value)) +
  geom_raster() +
  ggtheme_plot() +
  theme(axis.text = element_blank(), 
        axis.title = element_blank()) +
  scale_fill_gradientn(colors = c('green3', 'yellow', 'red3', 'purple4'),
                       values = c(0, .25, .5, 1)) +
  xlim(c(-100, 15)) + ylim(c(-10, 33)) +
  coord_fixed() +
  labs(title = 'Mean risk (mid-Atlantic), range-rarity weighted',
       fill  = 'mean(risk)')

ggplot(mean_df, aes(long, lat, fill = value)) +
  geom_raster() +
  ggtheme_plot() +
  theme(axis.text = element_blank(), 
        axis.title = element_blank()) +
  scale_fill_gradientn(colors = c('green3', 'yellow', 'red3', 'purple4'),
                       values = c(0, .25, .5, 1)) +
  xlim(c(75, 150)) + ylim(c(-30, 30)) +
  coord_fixed() +
  labs(title = 'Mean risk (Coral Triangle), range-rarity weighted',
       fill  = 'mean(risk)')

```

``` {r var_risk_raster, eval = FALSE}

var_rast <- subs(rast_base, cell_summary, by = 'cell_id', which = 'var_risk')
writeRaster(var_rast, file.path(dir_git, 'output', 'var_rr_risk_raster_010deg.tif'),
            overwrite = TRUE)

var_df <- var_rast %>% 
  rasterToPoints() %>% 
  as.data.frame() %>%
  setNames(c('long', 'lat', 'value'))

ggplot(var_df, aes(long, lat, fill = value)) +
  geom_raster() +
  ggtheme_plot() +
  theme(axis.text = element_blank(), 
        axis.title = element_blank()) +
  scale_fill_gradientn(colors = c('green3', 'yellow', 'red3', 'purple4'),
                       values = c(0, .25, .5, 1)) +
  coord_fixed() +
  labs(title = 'Variance of risk, range-rarity weighted',
       fill  = 'Var(risk)')

```

``` {r n_spp_risk}

n_spp_rast <- subs(rast_base, cell_summary, by = 'cell_id', which = 'sr_rr_risk')
writeRaster(n_spp_rast, file.path(dir_git, 'output', 'sr_rr_risk_raster_010deg.tif'),
            overwrite = TRUE)

n_spp_df <- n_spp_rast %>% 
  rasterToPoints() %>% 
  as.data.frame() %>%
  setNames(c('long', 'lat', 'value'))

ggplot(n_spp_df, aes(long, lat, fill = value)) +
  geom_raster() +
  ggtheme_plot() +
  theme(axis.text = element_blank(), 
        axis.title = element_blank()) +
  scale_fill_gradientn(colors = c('grey90', 'lightblue', 'blue1', 'blue3', 'blue4', 'purple4'),
                       values = c(0, .1, .25, .5, .75, 1)) +
  coord_fixed() +
  labs(title = 'Species richness (N assessed), range-rarity weighted',
       fill = 'N')
```

``` {r n_spp_threatened}

n_threat_rast <- subs(rast_base, cell_summary, by = 'cell_id', which = 'sr_rr_threatened')
writeRaster(n_threat_rast, file.path(dir_git, 'output', 'sr_rr_threat_raster_010deg.tif'),
            overwrite = TRUE)
### n_threat_rast <- raster(file.path(dir_git, 'output', 'sr_rr_threat_raster_010deg.tif'))
n_threat_df <- n_threat_rast %>% 
  rasterToPoints() %>% 
  as.data.frame() %>%
  setNames(c('long', 'lat', 'value'))


ggplot(n_threat_df, aes(long, lat, fill = value)) +
  geom_raster() +
  ggtheme_plot() +
  theme(axis.text = element_blank(), 
        axis.title = element_blank()) +
  scale_fill_gradientn(colors = c('grey90', 'coral', 'red1', 'red3', 'red4', 'purple4'),
                       values = c(0, .1, .25, .5, .75, 1)) +
  coord_fixed() +
  labs(title = 'Number of threatened species (VU, EN, CR), range-rarity weighted',
       fill  = 'N')

pct_threat_rast <- subs(rast_base, cell_summary, by = 'cell_id', which = 'pct_rr_threatened')
writeRaster(n_threat_rast, file.path(dir_git, 'output', 'sr_rr_pct_threat_raster_010deg.tif'),
            overwrite = TRUE)
### n_threat_rast <- raster(file.path(dir_git, 'output', 'sr_rr_pct_threat_raster_010deg.tif'))
pct_threat_df <- pct_threat_rast %>% 
  rasterToPoints() %>% 
  as.data.frame() %>%
  setNames(c('long', 'lat', 'value'))


ggplot(pct_threat_df, aes(long, lat, fill = value)) +
  geom_raster() +
  ggtheme_plot() +
  theme(axis.text = element_blank(), 
        axis.title = element_blank()) +
  scale_fill_gradientn(colors = c('grey90', 'coral', 'red2', 'red4', 'purple4'),
                       values = c(0, .4, .5, .6, 1)) +
  coord_fixed() +
  labs(title = 'Proportion of threatened species (VU, EN, CR), range-rarity weighted',
       fill  = 'proportion')

```

``` {r trend}

trend_rast <- subs(rast_base, cell_summary, by = 'cell_id', which = 'mean_trend')
writeRaster(trend_rast, file.path(dir_git, 'output', 'trend_rr_raster_010deg.tif'),
            overwrite = TRUE)

trend_df <- trend_rast %>% 
  rasterToPoints() %>% 
  as.data.frame() %>%
  setNames(c('long', 'lat', 'value'))

trend_range <-range(trend_df$value)
trend_0 <- -trend_range[1] / (trend_range[2] - trend_range[1])

ggplot(trend_df, aes(long, lat, fill = value)) +
  geom_raster() +
  ggtheme_plot() +
  theme(axis.text = element_blank(), 
        axis.title = element_blank()) +
  scale_fill_gradientn(colors = c('green4', 'green3', 'grey90', 'red3', 'purple4'),
                       values = c(0, trend_0/2, trend_0, 1 - (1 - trend_0)/2, 1)) +
  coord_fixed() +
  labs(title = 'Trend in risk, range-rarity weighted',
       fill  = 'trend')

```

``` {r n_trend}

n_trend_rast <- subs(rast_base, cell_summary, by = 'cell_id', which = 'sr_rr_trend')
writeRaster(n_trend_rast, file.path(dir_git, 'output', 'sr_rr_trend_raster_010deg.tif'),
            overwrite = TRUE)

n_trend_df <- n_trend_rast %>% 
  rasterToPoints() %>% 
  as.data.frame() %>%
  setNames(c('long', 'lat', 'value'))

ggplot(n_trend_df, aes(long, lat, fill = value)) +
  geom_raster() +
  ggtheme_plot() +
  theme(axis.text = element_blank(), 
        axis.title = element_blank()) +
  scale_fill_gradientn(colors = c('grey90', 'lightblue', 'blue1', 'blue3', 'blue4', 'purple4'),
                       values = c(0, .1, .25, .5, .75, 1)) +
  coord_fixed() +
  labs(title = 'Number of trend-assessed species, range-rarity weighted',
       fill  = 'N')
```

